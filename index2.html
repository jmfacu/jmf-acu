<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>jmf acu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- iPad/iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="jmf acu" />
  <meta name="theme-color" content="#4F3D5C" />

  <!-- home-screen icon (make sure icon-180.png is next to index.html) -->
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png?v=r2" />
  <link rel="icon" type="image/png" sizes="180x180" href="icon-180.png?v=r2" />

  <style>
  :root {
    --bg:#ffffff; --text:#444444; --muted:#666666;
    --card-bg:#ffffff; --border:#e5e7eb;
    --accent:#4F3D5C; --accent-text:#ffffff; --accent-green:#BADA55;
    --secondary:#666666; --danger:#4F3D5C;
    --font-heading:"Avenir Next",Avenir,-apple-system,system-ui,"Helvetica Neue",Helvetica,Arial,sans-serif;
    --font-body:   "Avenir Next",Avenir,-apple-system,system-ui,"Helvetica Neue",Helvetica,Arial,sans-serif;
    --radius:12px;
  }
  .dark { --bg:#121212; --text:#e6e6e6; --muted:#b3b3b3; --card-bg:#1b1b1b; --border:#2a2a2a; }

  *{box-sizing:border-box}
  body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:var(--font-body);font-weight:300;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .container{padding:16px;max-width:1100px;margin:0 auto}
  .header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px}
  h1,h2,h3,.section-title{font-family:var(--font-heading);font-weight:400;color:var(--text)}
  h1{font-size:28px;margin:0;text-transform:lowercase}
  .section-title{font-size:20px;font-weight:600;margin-top:20px;text-transform:lowercase;color:var(--accent)}
  .notice{font-size:12px;color:var(--muted);margin-top:6px}

  textarea,input[type="text"],select{
    width:100%;padding:10px;font-size:16px;background:var(--card-bg);color:var(--text);
    border:1px solid var(--border);border-radius:var(--radius)
  }
  textarea.output-box{height:420px;white-space:pre-wrap}
  hr{border:none;border-top:1px solid var(--border);margin:16px 0}
  .flex-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}

  button{
    padding:12px 16px;margin:4px 0;border:none;border-radius:var(--radius);
    font-size:16px;background:var(--accent);color:var(--accent-text);
    cursor:pointer;text-transform:lowercase;letter-spacing:.2px
  }
  button.secondary{background:var(--secondary);color:#fff}
  button.danger{background:var(--danger);color:#fff}
  .small-btn{padding:6px 10px;font-size:14px;background:var(--accent-green);color:#0b1324;border-radius:var(--radius)}
  button:hover{filter:brightness(.98)} button:active{transform:translateY(1px)}

  .preview{margin-top:12px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fdfdfd}
  .preview h3{margin:0 0 8px;font-size:18px;color:var(--accent)}
  .preview textarea{height:160px;white-space:pre-wrap}

  .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;align-items:center;justify-content:center;padding:16px}
  .modal{width:100%;max-width:720px;background:var(--card-bg);color:var(--text);border:1px solid var(--border);border-radius:16px;padding:16px}
  .progress-bar{height:10px;width:100%;background:#eee;border-radius:999px;overflow:hidden;margin:8px 0 12px}
  .progress-bar>div{height:100%;width:0%;background:var(--accent-green);transition:width .25s ease}
  .log{max-height:140px;overflow:auto;background:#fafafa;border:1px solid var(--border);border-radius:8px;padding:8px;font-size:13px}
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div style="display:flex;align-items:center;gap:12px;">
      <button aria-label="jmf acu" style="display:inline-flex;flex-direction:column;align-items:center;justify-content:center;width:84px;height:84px;padding:0;background:var(--accent);color:#fff;border-radius:18px;line-height:1.05;text-transform:lowercase;font-family:var(--font-heading);font-weight:600;">
        <span style="display:block;font-size:22px;letter-spacing:.5px">jmf</span><span style="display:block;font-size:22px;letter-spacing:.5px">acu</span>
      </button>
      <div>
        <h1>jmf acu <span style="font-size:12px;color:#999;font-weight:400">‚Ä¢ recovery build r2 (universal context capture)</span></h1>
        <div class="notice">two‚Äëpass with fallback; strict L/R/B + LV/KD/GB; captures any ‚Äúkey: value‚Äù answers and clinic‚Äërelevant details.</div>
      </div>
    </div>

    <!-- cost meter -->
    <div style="display:flex;flex-direction:column;gap:6px;min-width:280px;max-width:420px;background:#fafafa;border:1px solid var(--border);border-radius:12px;padding:10px 12px">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="font-size:14px;font-weight:600;color:var(--accent)">estimated cost (this month)</div>
        <div id="costCapText" class="notice">$0 / $15</div>
      </div>
      <div class="progress-bar"><div id="costBarFill"></div></div>
      <div class="flex-row" style="gap:6px;">
        <span id="costDollars"   style="padding:2px 8px;border-radius:99px;background:#f1f5f9;border:1px solid #e2e8f0;color:#475569">$0.00</span>
        <span id="costTokensIn"  style="padding:2px 8px;border-radius:99px;background:#f1f5f9;border:1px solid #e2e8f0;color:#475569">in: 0 tok</span>
        <span id="costTokensOut" style="padding:2px 8px;border-radius:99px;background:#f1f5f9;border:1px solid #e2e8f0;color:#475569">out: 0 tok</span>
      </div>
      <div id="costNote" class="notice">pricing used: $0.15/1m input, $0.60/1m output (change in ai settings).</div>
    </div>

    <div class="flex-row" style="gap:6px;">
      <button id="aiSettingsBtn" class="small-btn">ai settings</button>
      <button id="toggleTheme" class="secondary small" title="toggle dark / light">toggle</button>
    </div>
  </div>

  <div class="section-title">transcript input</div>
  <textarea id="inputText" placeholder="paste up to 60‚Äì90 min transcript here‚Ä¶"></textarea>
  <div class="flex-row">
    <button id="startMic">üé§ start dictation</button>
    <button id="stopMic" class="secondary">stop dictation</button>
    <button id="clearInput" class="danger">clear input</button>
    <button id="pasteDemo" class="small-btn">paste test text</button>
  </div>

  <div class="section-title">ai generation (two‚Äëpass with fallback)</div>
  <div class="flex-row">
    <button id="aiGenerate">ai generate note</button>
    <button id="duplicateLast" class="secondary">duplicate last</button>
  </div>
  <div class="notice">pass‚Äë1 extracts facts (preview below); pass‚Äë2 drafts; if pass‚Äë2 is thin, we build a complete note from pass‚Äë1 + your raw text (never losing details).</div>

  <div class="preview" id="pass1Preview" style="display:none;">
    <h3>ai summary preview (from pass 1)</h3>
    <div class="notice">fast outline of what was captured before drafting.</div>
    <textarea id="pass1Text" readonly></textarea>
  </div>

  <div class="section-title">output note</div>
  <textarea id="outputText" class="output-box" placeholder="your formatted note will appear here‚Ä¶"></textarea>
  <div class="flex-row">
    <button id="copyNote">copy to clipboard</button>
    <button id="clearOutput" class="danger">clear output</button>
    <button id="clearAll" class="danger">clear all</button>
  </div>

  <hr>
  <div class="notice">after any update: open with a fresh token (e.g., <code>?v=recovery-r2</code>) and re‚Äëadd to home screen.</div>
</div>

<!-- progress modal -->
<div id="tpModal" class="modal-backdrop">
  <div class="modal">
    <h2>generating note (two‚Äëpass)</h2>
    <div id="tpStep" class="notice">preparing‚Ä¶</div>
    <div class="progress-bar"><div id="tpProg"></div></div>
    <div class="log" id="tpLog"></div>
    <div style="text-align:right;margin-top:10px;">
      <button id="tpClose" class="secondary small">close</button>
    </div>
  </div>
</div>

<!-- AI settings modal -->
<div id="aiModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h2>ai settings</h2>
    <p class="notice">your key stays on this device (localStorage). tap ‚Äútest ai‚Äù before use.</p>

    <div class="grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px;">
      <div><label>provider</label><select id="aiProvider"><option value="openai">openai (api.openai.com)</option><option value="azure">azure openai</option></select></div>
      <div><label>model / deployment</label><input id="aiModel" type="text" placeholder="openai: gpt-4o-mini  |  azure: your-deployment-name"></div>
      <div><label>api key</label><input id="aiKey" type="text" placeholder="paste your api key"></div>
      <div><label>base url</label><input id="aiBaseUrl" type="text" placeholder="openai: https://api.openai.com  |  azure: https://YOUR-RESOURCE.openai.azure.com"></div>
      <div><label>azure api version (if azure)</label><input id="aiApiVersion" type="text" placeholder="e.g., 2024-02-15-preview"></div>
      <div><label>temperature</label><input id="aiTemp" type="number" min="0" max="1" step="0.1" value="0.2"></div>
      <div><label>monthly cap ($)</label><input id="aiCap" type="number" min="0" step="1" value="15"></div>
      <div><label>price ‚Äî input ($ / 1M tokens)</label><input id="aiPriceIn" type="number" min="0" step="0.01" value="0.15"></div>
      <div><label>price ‚Äî output ($ / 1M tokens)</label><input id="aiPriceOut" type="number" min="0" step="0.01" value="0.60"></div>
    </div>

    <div class="flex-row" style="justify-content:space-between;margin-top:12px;">
      <span class="notice">tip: also keep a hard cap in your openai dashboard.</span>
      <div class="flex-row" style="gap:6px;">
        <button id="aiTest" class="small-btn">test ai</button>
        <button id="aiSave" class="small-btn">save</button>
        <button id="aiClose" class="secondary small">close</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   theme & common elements
========================= */
const inputEl  = document.getElementById("inputText");
const outputEl = document.getElementById("outputText");
const p1WrapEl = document.getElementById("pass1Preview");
const p1TextEl = document.getElementById("pass1Text");

document.getElementById("toggleTheme").onclick = () => { document.body.classList.toggle("dark"); };

/* =========================
   speech (optional)
========================= */
let recognition, autoRestartMic=false;
if ("webkitSpeechRecognition" in window){
  recognition = new webkitSpeechRecognition();
  recognition.continuous = true; recognition.interimResults = true;
  recognition.onresult = (e)=>{
    let finalText=""; for(let i=e.resultIndex;i<e.results.length;i++){ if(e.results[i].isFinal) finalText+=e.results[i][0].transcript; }
    if(finalText.trim()!==""){ inputEl.value += (inputEl.value?" ":"") + finalText.toLowerCase(); }
  };
  recognition.onend = ()=>{ if(autoRestartMic) recognition.start(); };
}
document.getElementById("startMic").onclick = ()=>{ if(recognition){ autoRestartMic=true; recognition.start(); } else { alert("speech not available in this browser."); } };
document.getElementById("stopMic").onclick  = ()=>{ if(recognition){ autoRestartMic=false; recognition.stop(); } };

/* =========================
   clear / copy
========================= */
document.getElementById("clearInput").onclick  = ()=>{ inputEl.value=""; p1TextEl.value=""; p1WrapEl.style.display="none"; };
document.getElementById("copyNote").onclick    = ()=>{ outputEl.focus(); outputEl.select(); try{ document.execCommand("copy"); }catch{ navigator.clipboard.writeText(outputEl.value); } };
document.getElementById("clearOutput").onclick = ()=>{ outputEl.value=""; p1TextEl.value=""; p1WrapEl.style.display="none"; };
document.getElementById("clearAll").onclick    = ()=>{ inputEl.value=""; outputEl.value=""; p1TextEl.value=""; p1WrapEl.style.display="none"; localStorage.removeItem("lastNote"); window.__extListForICD=null; };
document.getElementById("pasteDemo").onclick   = ()=>{
  inputEl.value = "3 weeks of intense sitting. right piriformis trigger points. bilateral knee pain, worse on the left. pain going up stairs. likes cold water. favorite season is winter. bowel: loose 3x/day, worse after coffee. sleep: wakes 3am sweating. urine: frequent small volume, dark. cravings: salty. aversion: sweets. lv3, st44, gb34, yin tang, pc6, li11.";
};

/* =========================
   ai settings + cost meter
========================= */
const aiDefaults = { provider:"openai", baseUrl:"https://api.openai.com", model:"gpt-4o-mini", apiKey:"", apiVersion:"2024-02-15-preview", temperature:0.2, monthlyCap:15, priceIn:0.15, priceOut:0.60 };
function loadAIConfig(){ const raw=localStorage.getItem("aiConfig"); if(!raw) return {...aiDefaults}; try{ return {...aiDefaults, ...JSON.parse(raw)}; }catch{ return {...aiDefaults}; } }
function saveAIConfig(cfg){ localStorage.setItem("aiConfig", JSON.stringify(cfg)); }
const aiModal = document.getElementById("aiModalBackdrop");
document.getElementById("aiSettingsBtn").onclick = ()=>{
  const cfg=loadAIConfig();
  document.getElementById("aiProvider").value=cfg.provider;
  document.getElementById("aiBaseUrl").value=cfg.baseUrl;
  document.getElementById("aiModel").value=cfg.model;
  document.getElementById("aiKey").value=cfg.apiKey;
  document.getElementById("aiApiVersion").value=cfg.apiVersion;
  document.getElementById("aiTemp").value=cfg.temperature;
  document.getElementById("aiCap").value=cfg.monthlyCap;
  document.getElementById("aiPriceIn").value=cfg.priceIn;
  document.getElementById("aiPriceOut").value=cfg.priceOut;
  aiModal.style.display="flex";
};
document.getElementById("aiClose").onclick = ()=>{ aiModal.style.display="none"; };
document.getElementById("aiSave").onclick  = ()=>{
  const cfg = {
    provider:document.getElementById("aiProvider").value,
    baseUrl:(document.getElementById("aiBaseUrl").value||"").trim()||aiDefaults.baseUrl,
    model:(document.getElementById("aiModel").value||"").trim()||aiDefaults.model,
    apiKey:(document.getElementById("aiKey").value||"").trim(),
    apiVersion:(document.getElementById("aiApiVersion").value||"").trim()||aiDefaults.apiVersion,
    temperature:parseFloat(document.getElementById("aiTemp").value)||aiDefaults.temperature,
    monthlyCap:Math.max(0,parseFloat(document.getElementById("aiCap").value)||aiDefaults.monthlyCap),
    priceIn:Math.max(0,parseFloat(document.getElementById("aiPriceIn").value)||aiDefaults.priceIn),
    priceOut:Math.max(0,parseFloat(document.getElementById("aiPriceOut").value)||aiDefaults.priceOut)
  };
  saveAIConfig(cfg); aiModal.style.display="none"; renderCostUI();
};
document.getElementById("aiTest").onclick = async ()=>{
  const cfg=loadAIConfig(); if(!cfg.apiKey){ alert("paste your api key first."); return; }
  try{
    await aiChat(cfg,[{role:"system",content:'reply with {"ok":true} only (json).'}, {role:"user",content:"ping"}]);
    alert("ai test ok.");
  }catch(e){ alert("ai test failed: "+(e?.message||e)); }
};

const METER_KEY="costMeter";
function monthKeyNow(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`; }
function loadMeter(){ const raw=localStorage.getItem(METER_KEY); const mk=monthKeyNow(); let obj={month:mk,inTok:0,outTok:0}; if(raw){ try{ obj=JSON.parse(raw)||obj; }catch{} } if(obj.month!==mk) obj={month:mk,inTok:0,outTok:0}; return obj; }
function saveMeter(obj){ localStorage.setItem(METER_KEY, JSON.stringify(obj)); }
function charsToTokens(s){ if(!s) return 0; return Math.ceil(s.length/4); }
function estimateMessagesTokens(msgs){ let t=0; (msgs||[]).forEach(m=>t+=charsToTokens(m?.content||"")); return t; }
function addToMeter(inTok,outTok){ const m=loadMeter(); m.inTok+=Math.max(0,Math.floor(inTok||0)); m.outTok+=Math.max(0,Math.floor(outTok||0)); saveMeter(m); renderCostUI(); }
function currentCost(){ const cfg=loadAIConfig(); const m=loadMeter(); const dollars=(m.inTok/1e6)*cfg.priceIn+(m.outTok/1e6)*cfg.priceOut; return {dollars,inTok:m.inTok,outTok:m.outTok,cap:cfg.monthlyCap,priceIn:cfg.priceIn,priceOut:cfg.priceOut}; }
function renderCostUI(){
  const {dollars,inTok,outTok,cap,priceIn,priceOut}=currentCost();
  document.getElementById("costCapText").textContent = `$${dollars.toFixed(2)} / $${cap.toFixed(0)}`;
  const pct = cap>0 ? Math.min(100, Math.round((dollars/cap)*100)) : 0;
  const bar = document.getElementById("costBarFill");
  bar.style.width = pct+"%"; bar.style.background = (pct>=100)?"#E35D5D":(pct>=80?"#E3B75D":"#BADA55");
  document.getElementById("costDollars").textContent   = `$${dollars.toFixed(2)}`;
  document.getElementById("costTokensIn").textContent  = `in: ${inTok.toLocaleString()} tok`;
  document.getElementById("costTokensOut").textContent = `out: ${outTok.toLocaleString()} tok`;
  document.getElementById("costNote").textContent      = `pricing used: $${priceIn}/1m input, $${priceOut}/1m output (change in ai settings).`;
}
renderCostUI();

/* =========================
   chunking (long transcripts)
========================= */
const CHUNK_CHARS=8000, CHUNK_OVERLAP=800, MAX_TRIES=3;
function chunkTranscript(text){
  const chunks=[]; let i=0;
  while(i<text.length){ const end=Math.min(text.length,i+CHUNK_CHARS); chunks.push(text.slice(i,end).trim()); if(end>=text.length) break; i=end-CHUNK_OVERLAP; if(i<0) i=0; }
  return chunks.filter(Boolean);
}

/* =========================
   normalizers (L/R/B & LV/KD/GB)
========================= */
function normalizeLateralityText(s){
  if(!s) return s;
  s=s.replace(/\bbilateral\b|\bboth\b/gi,'B').replace(/\bleft\b/gi,'L').replace(/\bright\b/gi,'R').replace(/\brt\b/gi,'R').replace(/\blt\b/gi,'L');
  s=s.replace(/\b\(?([rlb])\)?(?=\s|:|;|,|\/|-|\)|$)/gi,(_m,g1)=>g1.toUpperCase());
  s=s.replace(/(^|[\n\r])\s*[‚Äì\-‚Ä¢]\s*([rlb])(?=\s|:)/gi,(_m,lead,side)=>`${lead}‚Äì ${side.toUpperCase()}`);
  return s;
}
function uppercaseMeridians(s){
  if(!s) return s;
  const mer=['lv','sp','gb','bl','st','lu','li','si','ht','pc','kd','cv','gv'];
  mer.forEach(m=>{
    const r1=new RegExp(`\\b${m}\\b`,'gi'); s=s.replace(r1,m.toUpperCase());
    const r2=new RegExp(`\\b${m}\\s?(\\d+)`,'gi'); s=s.replace(r2,(_a,n)=>`${m.toUpperCase()}${n}`);
  });
  s=s.replace(/\byin\s?tang\b/gi,'yintang');
  return s;
}
const norm = (s)=> uppercaseMeridians(normalizeLateralityText(s||""));

/* =========================
   local gleaner: universal context + key:value
========================= */
function gleanFromRaw(text){
  const t=(text||"").toLowerCase();
  const res={ points:[], personal:[], contextPairs:[], extraHPI:[] };
  // points
  const ptRe=/\b(lv|sp|gb|bl|st|lu|li|si|ht|pc|kd|cv|gv)\s?(\d{1,2})\b|y[ i]?n\s?tang\b/gi; let m;
  while((m=ptRe.exec(t))!==null){ if(m[0].match(/y[ i]?n\s?tang/i)){ if(!res.points.includes('yintang')) res.points.push('yintang'); } else { const full=`${m[1].toUpperCase()}${m[2]}`; if(!res.points.includes(full)) res.points.push(full); } }
  // key:value capture
  const pairRe=/\b([a-z ]{2,20})\s*:\s*([^.;\n\r]+)/gi; let p;
  while((p=pairRe.exec(t))!==null){ const k=(p[1]||'').trim(); const v=(p[2]||'').trim(); if(!k) continue; res.contextPairs.push(`${k}: ${v}`); if(k==='thirst'&&/cold/.test(v)) res.personal.push('prefers cold water'); if(k==='thirst'&&/hot/.test(v)) res.personal.push('prefers hot water'); if(k==='season'&&v) res.personal.push(`favorite season: ${v}`); }
  if(/\blikes?\s+(cold|iced)\s+water\b/.test(t)) res.personal.push('prefers cold water');
  if(/\blikes?\s+hot\s+water\b/.test(t))         res.personal.push('prefers hot water');
  const sm=t.match(/\bfavorite (?:season\s*is|season:)?\s*(spring|summer|fall|autumn|winter)\b/); if(sm) res.personal.push(`favorite season: ${sm[1]==='autumn'?'fall':sm[1]}`);
  if(/intense sitting|prolonged sitting|long sitting/.test(t)) res.personal.push('job: prolonged sitting');
  if(/going up stairs|up stairs|climbing stairs/.test(t)) res.extraHPI.push('pain going up stairs');
  if(/\bworse on the left\b/.test(t)) res.extraHPI.push('worse on the L');
  if(/\bbilateral knee\b/.test(t))   res.extraHPI.push('B knee pain');
  return res;
}

/* =========================
   ai caller with retries
========================= */
async function aiChat(cfg,messages){
  const base=(cfg.baseUrl||"https://api.openai.com").replace(/\/+$/,'');
  const inTok=estimateMessagesTokens(messages);
  let url,headers,body;
  if(cfg.provider==='azure'){
    url=`${base}/openai/deployments/${encodeURIComponent(cfg.model)}/chat/completions?api-version=${encodeURIComponent(cfg.apiVersion)}`;
    headers={"Content-Type":"application/json","api-key":cfg.apiKey};
    body={temperature:cfg.temperature??0.2,response_format:{type:"json_object"},messages};
  }else{
    url=`${base}/v1/chat/completions`;
    headers={"Content-Type":"application/json","Authorization":`Bearer ${cfg.apiKey}`};
    body={model:cfg.model||"gpt-4o-mini",temperature:cfg.temperature??0.2,response_format:{type:"json_object"},messages};
  }
  let lastText="";
  for(let attempt=1;attempt<=3;attempt++){
    const resp=await fetch(url,{method:"POST",headers,body:JSON.stringify(body)});
    if(resp.ok){ const data=await resp.json(); const content=data?.choices?.[0]?.message?.content||data?.choices?.[0]?.text||""; if(!content) throw new Error("no content in response"); const outTok=charsToTokens(content); addToMeter(inTok,outTok); return content; }
    try{ lastText=await resp.clone().text(); }catch{ lastText=""; }
    if(resp.status===429 && attempt<3){ await new Promise(r=>setTimeout(r,[2000,4000,8000][attempt-1])); continue; }
    if(resp.status===401) throw new Error("unauthorized (401): check your api key.");
    if(resp.status>=500 && attempt<3){ await new Promise(r=>setTimeout(r,1500)); continue; }
    throw new Error(`api ${resp.status}: ${lastText||"no server message"}`);
  }
  throw new Error("api 429: still rate-limited after retries; try again shortly.");
}

/* =========================
   herb fallback
========================= */
function herbFallbackFromTCM(tcmDxArr){
  try{
    const txt=(tcmDxArr||[]).join('; ').toLowerCase();
    const picks=[]; const push=x=>{ if(x && !picks.includes(x)) picks.push(x); };
    if(/lv qi stagnation|liver qi/.test(txt)){ push('xiao yao wan'); if(/heat|irrit/.test(txt)) push('jia wei xiao yao wan'); }
    if(/blood stasis/.test(txt)) push('shen tong zhu yu wan');
    if(/wind|cold|damp/.test(txt) && /bi/.test(txt)){ push('du huo ji sheng wan'); push('juan bi wan'); }
    if(!picks.length) push('shen tong zhu yu wan');
    return picks.slice(0,2);
  }catch{ return ['shen tong zhu yu wan']; }
}

/* =========================
   fallback composer (from pass‚Äë1 + gleaner)
========================= */
function buildFinalJsonFromExtracts(extList, glean){
  const H=[], M=[], R=[], T=[], PC=[], TCM=[], ICD=[], HERB=[], PTS=[], CR=[], QAP=[];
  (extList||[]).forEach(e=>{
    (e?.hpi_bits||[]).forEach(x=>H.push(x));
    (e?.muscles||[]).forEach(m=>M.push(`${m.side||''} ${m.name||''}: ${(m.findings||[]).join('/')}`.trim()));
    (e?.rom||[]).forEach(x=>R.push(x));
    (e?.muscle_tests||[]).forEach(x=>T.push(x));
    (e?.personal_context||[]).forEach(x=>PC.push(x));
    (e?.tcm_clues||[]).forEach(x=>TCM.push(x));
    (e?.icd_candidates||[]).forEach(x=>ICD.push(x));
    (e?.herb_candidates||[]).forEach(x=>HERB.push(x));
    (e?.points_mentioned||[]).forEach(x=>PTS.push(x));
    (e?.clinically_relevant||[]).forEach(x=>CR.push(x));
    (e?.qa_pairs||[]).forEach(q=>{ const k=(q?.q||'').trim(); const v=(q?.a||'').trim(); if(k||v) QAP.push(`${k}${(k&&v)?": ":''}${v}`.trim()); });
  });
  const pcSet=new Set(PC); (glean?.personal||[]).forEach(x=>pcSet.add(x));
  const pointsUsed=Array.from(new Set([...(glean?.points||[]), ...PTS.map(p=>String(p).toUpperCase())])).filter(Boolean);
  const clinically = Array.from(new Set([...(CR||[]), ...(QAP||[]), ...((glean?.contextPairs)||[])])).slice(0,20);
  return {
    hpi: (H[0] || "follow‚Äëup for pain and mobility concerns."),
    subjective: { sections: [ { header:"general", bullets: Array.from(new Set([...(glean?.extraHPI||[]), ...H])).slice(0,8) }, ...(clinically.length?[{ header:"clinically relevant context", bullets: clinically }]:[]) ] },
    objective: { sections: [ { header:"muscles", bullets:Array.from(new Set(M)).slice(0,10) }, { header:"rom", bullets:Array.from(new Set(R)).slice(0,8) }, { header:"muscle testing", bullets:Array.from(new Set(T)).slice(0,8) } ].filter(x=>x.bullets.length) },
    personal_context: Array.from(pcSet).slice(0,10),
    tongue: "deduced: not specified", pulse: "deduced: not specified",
    assessment: { bullets: Array.from(new Set([ ...(M.length?["myofascial involvement of hip stabilizers"]:[]), ...(R.length?["functional limitation with stairs/hip flexion"]:[]) ])).slice(0,4), tcm_dx: Array.from(new Set(TCM.length?TCM:["lv qi stagnation","blood stasis in the channels"])) .slice(0,3) },
    treatment_principle: ["move qi and blood","relax hypertonic musculature"],
    acupuncture_plan: { channels:"LV, SP, GB, BL, ST as indicated; local ashi", points_used: pointsUsed.length?pointsUsed:["LV3","GB34","KD3"], interventions:["acupuncture","motor/trigger point release"], adjuncts:["infrared","cupping","guasha"] },
    herb_formulas: HERB.length?Array.from(new Set(HERB)).slice(0,2):herbFallbackFromTCM(TCM),
    advice:["gentle mobility within tolerance","heat as indicated"],
    icd10:Array.from(new Set(ICD)).slice(0,4), confidence:0.66, assumptions:["constructed from pass‚Äë1 facts + local parsing due to limited pass‚Äë2 output"]
  };
}

/* =========================
   render note
========================= */
function coerceConfidence(v){ if(typeof v!=="number"||!isFinite(v)) return 0.66; if(v<0.55) return 0.66; if(v>0.95) return 0.95; return v; }
function ensureHipICD(extList,icdArr){
  try{ const txt=JSON.stringify(extList).toLowerCase(); if(!txt.includes('hip')) return icdArr; const has=(icdArr||[]).some(x=>/m25\.55[129]/i.test(x)); if(has) return icdArr; let code='M25.559 pain in unspecified hip'; if(/(r\s?hip|right hip)/i.test(txt)) code='M25.551 pain in R hip'; else if(/(l\s?hip|left hip)/i.test(txt)) code='M25.552 pain in L hip'; return [...(icdArr||[]), code]; }catch{ return icdArr; }
}
function renderNoteFromJSON(j){
  function bullets(arr){ return (arr||[]).map(s=>"‚Äì "+(s||"")).join("\n"); }
  function sections(sec){ if(!sec||!sec.sections) return ""; return sec.sections.map(s=>{ let hdr=s.header||""; let blt=bullets(s.bullets||[]); hdr=uppercaseMeridians(normalizeLateralityText(hdr)); blt=uppercaseMeridians(normalizeLateralityText(blt)); return hdr + (blt?("\n"+blt):""); }).join("\n"); }
  let subjBlock = j.subjective || { sections: [] };
  const clinicalBullets = [ ...((j.clinically_relevant||[])), ...((j.qa_pairs||[]).map(q=>{ const k=(q?.q||"").trim(); const v=(q?.a||"").trim(); return (k||v)?`${k}${(k&&v)?": ":''}${v}`: ""; }).filter(Boolean)) ];
  if (clinicalBullets.length){ subjBlock.sections = (subjBlock.sections||[]).concat([{ header:"clinically relevant context", bullets: clinicalBullets }]); }
  const hpi  = "hpi:\n‚Äì " + norm(j.hpi||"follow‚Äëup for pain and mobility concerns");
  const subj = "subjective:\n" + (sections(subjBlock)||"general\n‚Äì no specific subjective items captured");
  const obj  = "objective:\n" + (sections(j.objective)||"");
  const pc   = (j.personal_context && j.personal_context.length) ? ("personal context:\n" + bullets((j.personal_context||[]).map(norm))) : "";
  const tongue = "tongue:\n" + norm(j.tongue || "deduced: not specified");
  const pulse  = "pulse:\n"  + norm(j.pulse  || "deduced: not specified");
  const assess = "assessment (including tcm diagnosis):\n" + bullets((j.assessment?.bullets||[]).map(norm));
  const tcmdx  = "tcm diagnosis:\n" + bullets((j.assessment?.tcm_dx||[]).map(norm));
  const principle = "treatment principle:\n" + bullets((j.treatment_principle||[]).map(norm));
  const plan = (()=>{ const ch=norm(j.acupuncture_plan?.channels||"LV, SP, GB, BL, ST as indicated; local ashi"); const pts=(j.acupuncture_plan?.points_used||[]).map(norm).join(", "); const ints=bullets((j.acupuncture_plan?.interventions||[]).map(norm)); const adj=bullets((j.acupuncture_plan?.adjuncts||[]).map(norm)); return ["acupuncture plan:","acupuncture","‚Äì channels: "+ch,"‚Äì points used: "+(pts||"as clinically indicated"), ints?ints:"","adjunct therapies", adj?adj:""] .filter(Boolean).join("\n"); })();
  let herbs = "herbal recommendations (patent formulas):\n" + bullets((j.herb_formulas||[]).map(norm)); if(!j.herb_formulas||!j.herb_formulas.length){ const fb=herbFallbackFromTCM(j.assessment?.tcm_dx||[]); herbs = "herbal recommendations (patent formulas):\n" + bullets(fb); }
  const advice = "advice:\n" + bullets((j.advice||[]).map(norm));
  let icdArr = (j.icd10||[]).map(x=>normalizeLateralityText(x||"")); if(window.__extListForICD){ icdArr=ensureHipICD(window.__extListForICD, icdArr); }
  const icd  = icdArr && icdArr.length ? ("icd-10 codes:\n" + bullets(icdArr)) : "";
  const note = [ hpi, "", subj, "", obj, "", pc?pc+"\n":"", tongue, "", pulse, "", assess, "", tcmdx, "", principle, "", plan, "", herbs, "", advice, "", "confidence & assumptions:\n‚Äì confidence: " + (typeof j.confidence==="number" ? coerceConfidence(j.confidence).toFixed(2) : "0.66"), (j.assumptions && j.assumptions.length ? bullets(j.assumptions.map(norm)) : ""), "", icd ].join("\n");
  return uppercaseMeridians(normalizeLateralityText(note));
}

/* =========================
   two‚Äëpass driver
========================= */
const tpModal=document.getElementById('tpModal'), tpProg=document.getElementById('tpProg'), tpStep=document.getElementById('tpStep'), tpLog=document.getElementById('tpLog');
document.getElementById('tpClose').onclick=()=> tpModal.style.display='none';

document.getElementById("aiGenerate").onclick = async ()=>{
  const raw=(inputEl.value||"").trim();
  if(!raw){ alert("paste or dictate a transcript first."); return; }
  const cfg=loadAIConfig();
  if(!cfg.apiKey){ alert("open ai settings ‚Üí paste your api key ‚Üí test ai ‚Üí save."); return; }
  const glean=gleanFromRaw(raw);
  try{
    tpModal.style.display='flex'; tpStep.textContent="pass 1 of 2 ‚Äî extracting facts‚Ä¶"; tpProg.style.width='0%'; tpLog.textContent="splitting transcript‚Ä¶";
    const chunks=chunkTranscript(raw); if(!chunks.length) throw new Error("no content after chunking.");
    const extList=[];
    for(let i=0;i<chunks.length;i++){
      tpProg.style.width = Math.round((i/Math.max(1,(chunks.length+1)))*100) + "%";
      tpStep.textContent = `pass 1 ‚Äî chunk ${i+1} of ${chunks.length}`; tpLog.textContent += `\nprocessing chunk ${i+1}/${chunks.length}‚Ä¶`;
      const sys1=[
        "you are a careful tcm-intake extractor for an acupuncture clinic.",
        "task: read ONLY the provided transcript chunk and output STRICT JSON with facts (no rewriting, no opinions).",
        "use lowercase for prose; laterality abbreviations r/l/b only.",
        "json schema:",
        "{",
        '  "hpi_bits": ["short phrases"],',
        '  "muscles": [ {"name":"gluteus medius","side":"r|l|b|","findings":["tight","tender","knots","adhesions","ropey"]} ],',
        '  "rom": ["hip flexion limited ~20¬∞"],',
        '  "muscle_tests": ["hip abduction 4/5 r"],',
        '  "subjective_sections": [ {"header":"string","bullets":["string"]} ],',
        '  "objective_sections":  [ {"header":"string","bullets":["string"]} ],',
        '  "personal_context": ["job: ‚Ä¶","habits: ‚Ä¶","preferences: ‚Ä¶"],',
        '  "tcm_clues": ["lv qi stagnation","blood stasis","damp","heat","cold","deficiency","excess","wind","phlegm"],',
        '  "points_mentioned": ["lv3","gb34","st44","yintang","pc6","li11"],',
        '  "icd_candidates": ["m25.551 r hip pain"],',
        '  "herb_candidates": ["jia wei xiao yao wan"],',
        '  "clinically_relevant": ["label: value","anything clinically relevant"],',
        '  "qa_pairs": [{"q":"bowel","a":"loose 3x/day"},{"q":"sleep","a":"wakes 3am"},{"q":"urine","a":"dark, frequent"}]',
        "}",
        "return ONLY the json."
      ].join("\n");
      const content = await aiChat(cfg,[{role:"system",content:sys1},{role:"user",content:chunks[i]}]);
      let json; try{ json=JSON.parse(content); }catch(e){ const m=content.match(/\{[\s\S]*\}$/); if(m) json=JSON.parse(m[0]); else throw new Error("could not parse pass‚Äë1 json"); }
      extList.push(json);
    }
    if(glean.points.length || glean.personal.length || glean.contextPairs.length || glean.extraHPI.length){ extList.push({ hpi_bits:glean.extraHPI, personal_context:glean.personal, points_mentioned:glean.points.map(p=>p.toLowerCase()), clinically_relevant:glean.contextPairs }); }
    window.__extListForICD = extList;

    const outline=[]; const add=(hdr,a)=>{ if(a && a.length){ outline.push(hdr+":"); Array.from(new Set(a)).forEach(s=>outline.push("‚Äì "+s)); outline.push(""); } };
    const H=[],M=[],R=[],T=[],PC=[],PTS=[],TCM=[],ICD=[],HERB=[],CR=[],QAP=[];
    extList.forEach(e=>{ (e.hpi_bits||[]).forEach(x=>H.push(x)); (e.muscles||[]).forEach(m=>M.push(`${m.side||''} ${m.name||''}: ${(m.findings||[]).join('/')}`.trim())); (e.rom||[]).forEach(x=>R.push(x)); (e.muscle_tests||[]).forEach(x=>T.push(x)); (e.personal_context||[]).forEach(x=>PC.push(x)); (e.points_mentioned||[]).forEach(x=>PTS.push(x)); (e.tcm_clues||[]).forEach(x=>TCM.push(x)); (e.icd_candidates||[]).forEach(x=>ICD.push(x)); (e.herb_candidates||[]).forEach(x=>HERB.push(x)); (e.clinically_relevant||[]).forEach(x=>CR.push(x)); (e.qa_pairs||[]).forEach(q=>{ const k=(q?.q||'').trim(); const v=(q?.a||'').trim(); if(k||v) QAP.push(`${k}${(k&&v)?": ":''}${v}`.trim()); }); });
    add("hpi highlights",H); add("muscles (raw)",M); add("rom (raw)",R); add("muscle tests (raw)",T); add("personal context",PC); add("points mentioned",PTS); add("clinically relevant",CR.concat(QAP)); add("tcm clues",TCM); add("icd candidates",ICD); add("herb candidates",HERB);
    p1TextEl.value = outline.join("\n").trim() || "(no preview items extracted)"; p1WrapEl.style.display="block";

    const nothingUseful=!extList.length || extList.every(e=> (!e?.hpi_bits||!e.hpi_bits.length)&&(!e?.muscles||!e.muscles.length)&&(!e?.rom||!e.rom.length)&&(!e?.subjective_sections||!e.subjective_sections.length)&&(!e?.objective_sections||!e.objective_sections.length)&&(!e?.points_mentioned||!e.points_mentioned.length)&&(!e?.personal_context||!e.personal_context.length)&&(!e?.clinically_relevant||!e.clinically_relevant.length)&&(!e?.qa_pairs||!e.qa_pairs.length) );
    if(nothingUseful){ tpStep.textContent="stopped ‚Äî nothing extracted"; tpLog.textContent+="\nno facts captured in pass‚Äë1. check ai settings ‚Üí test ai; paste a short transcript and try again."; return; }

    tpStep.textContent="pass 2 of 2 ‚Äî drafting final note‚Ä¶"; tpProg.style.width="90%"; tpLog.textContent+="\nconsolidating‚Ä¶";
    const sys2=[
      "you are a tcm-savvy clinical scribe for an acupuncture practice.",
      "use ALL extracted facts (array of chunk extracts) to write ONE consolidated note.",
      "rules:",
      "- prose lowercase, but laterality must be R/L/B only (never write the words left/right/bilateral).",
      "- tcm channels/points UPPERCASE (LV, KD, GB; LV3, GB34, etc.).",
      "- objective: include muscles (with findings), rom, and muscle testing.",
      "- include personal context (job/lifestyle/preferences like thermal/season).",
      "- include clinically relevant context (key:value items or nuanced answers) as a section under subjective.",
      "- if tongue/pulse not explicit, DEDUCE and label as deduced.",
      "- assessment includes biomedical descriptors when appropriate (e.g., myofascial pain syndrome) alongside tcm.",
      "- tcm dx uses textbook patterns (lv qi stagnation, blood stasis in the channels, kd yin deficiency, shen disturbance).",
      "- herbs REQUIRED (1‚Äì2 patent formulas) aligned with bensky/cam.",
      "- icd10: choose 3‚Äì4 codes, with correct laterality when present.",
      "- confidence realistic 0.55‚Äì0.9.",
      "respond ONLY with json using the agreed schema."
    ].join("\n");

    let finalJson;
    try{
      const content2 = await aiChat(cfg,[{role:"system",content:sys2},{role:"user",content:JSON.stringify({extracts:extList})}]);
      finalJson = JSON.parse(content2);
    }catch(e){ const m=e && typeof e==="string" ? e.match(/\{[\s\S]*\}$/) : null; finalJson = m ? JSON.parse(m[0]) : {}; }

    const hasHpi = typeof finalJson?.hpi==="string" && finalJson.hpi.trim().length>0;
    const hasObj = Array.isArray(finalJson?.objective?.sections) && finalJson.objective.sections.some(s=>(s.bullets||[]).length);

    if(!hasHpi && !hasObj){ finalJson = buildFinalJsonFromExtracts(extList,glean); }
    else {
      // merge clinically relevant
      const mergedClinical = Array.from(new Set([ ...((finalJson.clinically_relevant||[])), ...((finalJson.qa_pairs||[]).map(q=>{ const k=(q?.q||'').trim(); const v=(q?.a||'').trim(); return (k||v)?`${k}${(k&&v)?": ":''}${v}`: ""; }).filter(Boolean)), ...((glean.contextPairs)||[]) ]));
      if(mergedClinical.length){ finalJson.clinically_relevant = mergedClinical; }
      // ensure points & personal context
      try{ if(!finalJson?.acupuncture_plan?.points_used?.length && glean.points.length){ finalJson.acupuncture_plan = finalJson.acupuncture_plan || {}; finalJson.acupuncture_plan.points_used = glean.points; }
        const pcSet=new Set(finalJson.personal_context||[]); (glean.personal||[]).forEach(x=>pcSet.add(x)); finalJson.personal_context = Array.from(pcSet);
      }catch{}
    }

    finalJson.confidence = (function(v){ if(typeof v!=="number"||!isFinite(v)) return 0.66; if(v<0.55) return 0.66; if(v>0.95) return 0.95; return v; })(finalJson.confidence);
    const note = (function(j){
      function bullets(arr){ return (arr||[]).map(s=>"‚Äì "+(s||"")).join("\n"); }
      function sections(sec){ if(!sec||!sec.sections) return ""; return sec.sections.map(s=>{ let hdr=s.header||""; let blt=bullets(s.bullets||[]); hdr=uppercaseMeridians(normalizeLateralityText(hdr)); blt=uppercaseMeridians(normalizeLateralityText(blt)); return hdr + (blt?("\n"+blt):""); }).join("\n"); }
      let subjBlock = j.subjective || { sections: [] };
      const clinicalBullets = [ ...((j.clinically_relevant||[])), ...((j.qa_pairs||[]).map(q=>{ const k=(q?.q||"").trim(); const v=(q?.a||"").trim(); return (k||v)?`${k}${(k&&v)?": ":''}${v}`: ""; }).filter(Boolean)) ];
      if (clinicalBullets.length){ subjBlock.sections = (subjBlock.sections||[]).concat([{ header:"clinically relevant context", bullets: clinicalBullets }]); }
      const hpi  = "hpi:\n‚Äì " + norm(j.hpi||"follow‚Äëup for pain and mobility concerns");
      const subj = "subjective:\n" + (sections(subjBlock)||"general\n‚Äì no specific subjective items captured");
      const obj  = "objective:\n" + (sections(j.objective)||"");
      const pc   = (j.personal_context && j.personal_context.length) ? ("personal context:\n" + bullets((j.personal_context||[]).map(norm))) : "";
      const tongue = "tongue:\n" + norm(j.tongue || "deduced: not specified");
      const pulse  = "pulse:\n"  + norm(j.pulse  || "deduced: not specified");
      const assess = "assessment (including tcm diagnosis):\n" + bullets((j.assessment?.bullets||[]).map(norm));
      const tcmdx  = "tcm diagnosis:\n" + bullets((j.assessment?.tcm_dx||[]).map(norm));
      const principle = "treatment principle:\n" + bullets((j.treatment_principle||[]).map(norm));
      const plan = (()=>{ const ch=norm(j.acupuncture_plan?.channels||"LV, SP, GB, BL, ST as indicated; local ashi"); const pts=(j.acupuncture_plan?.points_used||[]).map(norm).join(", "); const ints=bullets((j.acupuncture_plan?.interventions||[]).map(norm)); const adj=bullets((j.acupuncture_plan?.adjuncts||[]).map(norm)); return ["acupuncture plan:","acupuncture","‚Äì channels: "+ch,"‚Äì points used: "+(pts||"as clinically indicated"), ints?ints:"","adjunct therapies", adj?adj:""] .filter(Boolean).join("\n"); })();
      let herbs = "herbal recommendations (patent formulas):\n" + bullets((j.herb_formulas||[]).map(norm)); if(!j.herb_formulas||!j.herb_formulas.length){ const fb=herbFallbackFromTCM(j.assessment?.tcm_dx||[]); herbs = "herbal recommendations (patent formulas):\n" + bullets(fb); }
      const advice = "advice:\n" + bullets((j.advice||[]).map(norm));
      let icdArr = (j.icd10||[]).map(x=>normalizeLateralityText(x||"")); if(window.__extListForICD){ icdArr=ensureHipICD(window.__extListForICD, icdArr); }
      const icd  = icdArr && icdArr.length ? ("icd-10 codes:\n" + bullets(icdArr)) : "";
      const note = [ hpi, "", subj, "", obj, "", pc?pc+"\n":"", tongue, "", pulse, "", assess, "", tcmdx, "", principle, "", plan, "", herbs, "", advice, "", "confidence & assumptions:\n‚Äì confidence: " + (typeof j.confidence==="number" ? j.confidence.toFixed(2) : "0.66"), (j.assumptions && j.assumptions.length ? bullets(j.assumptions.map(norm)) : ""), "", icd ].join("\n");
      return uppercaseMeridians(normalizeLateralityText(note));
    })(finalJson);

    outputEl.value = note; localStorage.setItem("lastNote", note);
    tpProg.style.width="100%"; tpStep.textContent="done"; tpLog.textContent += (!hasHpi && !hasObj)?"\npass‚Äë2 was thin ‚Äî composed final note from pass‚Äë1 + local parsing ‚úî":"\ncompleted ‚úî";
  }catch(e){ tpStep.textContent="error"; tpLog.textContent += "\nerror: "+(e?.message||e); }
};

/* duplicate last */
document.getElementById("duplicateLast").onclick=()=>{ const last=localStorage.getItem("lastNote"); if(last) outputEl.value=last; };
</script>

</body>
</html>
