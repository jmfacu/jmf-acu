<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>jmf acu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="jmf acu" />
  <meta name="theme-color" content="#4F3D5C" />
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png?v=r2c" />
  <style>
    :root{--bg:#fff;--text:#444;--muted:#666;--card-bg:#fff;--border:#e5e7eb;--accent:#4F3D5C;--accent-text:#fff;--accent-green:#BADA55;--secondary:#666;--danger:#4F3D5C;--radius:12px}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial}
    .container{padding:16px;max-width:1100px;margin:0 auto}
    .header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px}
    h1{margin:0 0 6px;font:400 28px system-ui;text-transform:lowercase}
    .section-title{font:600 20px system-ui;margin-top:20px;color:var(--accent);text-transform:lowercase}
    .notice{font-size:12px;color:var(--muted);margin-top:6px}
    textarea,input,select{width:100%;padding:10px;font-size:16px;background:var(--card-bg);color:var(--text);border:1px solid var(--border);border-radius:var(--radius)}
    textarea.output-box{height:420px;white-space:pre-wrap}
    .flex-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{padding:12px 16px;border:0;border-radius:12px;background:var(--accent);color:#fff;font-size:16px;text-transform:lowercase;letter-spacing:.2px;cursor:pointer}
    button.secondary{background:var(--secondary)} button.danger{background:var(--danger)} .small-btn{padding:6px 10px;font-size:14px;background:var(--accent-green);color:#0b1324;border-radius:12px}
    .preview{margin-top:12px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fdfdfd}
    .preview textarea{height:160px;white-space:pre-wrap}
    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;align-items:center;justify-content:center;padding:16px}
    .modal{width:100%;max-width:720px;background:var(--card-bg);color:var(--text);border:1px solid var(--border);border-radius:16px;padding:16px}
    .progress-bar{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin:8px 0 12px}
    .progress-bar>div{height:100%;width:0;background:#BADA55;transition:width .25s ease}
    .log{max-height:140px;overflow:auto;background:#fafafa;border:1px solid var(--border);border-radius:8px;padding:8px;font-size:13px}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:84px;height:84px;background:#4F3D5C;color:#fff;border-radius:18px;display:flex;align-items:center;justify-content:center;font:600 22px system-ui;flex-direction:column;line-height:1.05"><span>jmf</span><span>acu</span></div>
      <div>
        <h1>jmf acu <span style="font:400 12px system-ui;color:#999">â€¢ recovery build r2c (tools toggle)</span></h1>
        <div class="notice">universal context capture â€¢ twoâ€‘pass with fallback â€¢ L/R/B + LV/KD/GB â€¢ default confidence 0.88</div>
      </div>
    </div>
    <div class="flex-row">
      <button id="aiSettingsBtn" class="small-btn">ai settings</button>
      <button id="toggleTheme" class="secondary small">toggle</button>
    </div>
  </div>

  <div class="section-title">transcript input</div>
  <textarea id="inputText" placeholder="paste transcript (60â€“90 min ok)â€¦"></textarea>
  <div class="flex-row">
    <button id="startMic">ðŸŽ¤ start dictation</button>
    <button id="stopMic" class="secondary">stop dictation</button>
    <button id="clearInput" class="danger">clear input</button>
    <button id="pasteDemo" class="small-btn">paste test text</button>
  </div>

  <div class="section-title">ai generation (twoâ€‘pass with fallback)</div>
  <div class="flex-row">
    <button id="aiGenerate">ai generate note</button>
    <button id="duplicateLast" class="secondary">duplicate last</button>
  </div>
  <div class="notice">passâ€‘1 extracts facts; passâ€‘2 drafts; if passâ€‘2 is thin, we compose from passâ€‘1 + your raw text (no detail loss).</div>

  <div class="section-title">tools</div>
  <div class="flex-row">
    <button id="toggleTools" class="secondary">show tools</button>
  </div>
  <div id="toolsPanel" style="display:none; margin-top:10px; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#f8fafc">
    <div class="section-title">quick modules</div>
    <div id="moduleButtons"></div>
    <div class="flex-row">
      <select id="moduleDropdown"></select>
      <button id="insertModule" class="small-btn">insert</button>
    </div>

    <div class="section-title">acupuncture point combos</div>
    <div id="comboButtons"></div>
    <div class="flex-row">
      <select id="comboDropdown"></select>
      <button id="insertCombo" class="small-btn">insert</button>
    </div>

    <div class="section-title">herbal recommendations (patent formulas)</div>
    <div id="herbButtons"></div>
    <div class="flex-row">
      <select id="herbDropdown"></select>
      <button id="insertHerb" class="small-btn">add formula</button>
    </div>

    <div class="section-title">icd-10 favorites</div>
    <div class="flex-row">
      <select id="icdDropdown"></select>
      <button id="addICD" class="small-btn">add to output</button>
    </div>
  </div>

  <div class="preview" id="pass1Preview" style="display:none;">
    <h3 style="margin:0 0 8px;color:#4F3D5C">ai summary preview (from pass 1)</h3>
    <div class="notice">fast outline of captured items.</div>
    <textarea id="pass1Text" readonly></textarea>
  </div>

  <div class="section-title">output note</div>
  <textarea id="outputText" class="output-box" placeholder="your formatted note will appear hereâ€¦"></textarea>
  <div class="flex-row">
    <button id="copyNote">copy to clipboard</button>
    <button id="clearOutput" class="danger">clear output</button>
    <button id="clearAll" class="danger">clear all</button>
  </div>

  <hr>
  <div class="notice">tip: use a fresh token when you update (e.g., <code>?v=r2c</code>) and reâ€‘add to home screen.</div>
</div>

<div id="tpModal" class="modal-backdrop"><div class="modal"><h2>generating note (twoâ€‘pass)</h2><div id="tpStep" class="notice">preparingâ€¦</div><div class="progress-bar"><div id="tpProg"></div></div><div class="log" id="tpLog"></div><div style="text-align:right;margin-top:10px;"><button id="tpClose" class="secondary small">close</button></div></div></div>

<div id="aiModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h2>ai settings</h2>
    <p class="notice">key is stored locally on this device. test before use.</p>
    <div class="grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px;">
      <div><label>provider</label><select id="aiProvider"><option value="openai">openai (api.openai.com)</option><option value="azure">azure openai</option></select></div>
      <div><label>model / deployment</label><input id="aiModel" type="text" placeholder="openai: gpt-4o-mini  |  azure: your-deployment-name"></div>
      <div><label>api key</label><input id="aiKey" type="text" placeholder="paste your api key"></div>
      <div><label>base url</label><input id="aiBaseUrl" type="text" placeholder="openai: https://api.openai.com  |  azure: https://YOUR-RESOURCE.openai.azure.com"></div>
      <div><label>azure api version (if azure)</label><input id="aiApiVersion" type="text" placeholder="e.g., 2024-02-15-preview"></div>
      <div><label>temperature</label><input id="aiTemp" type="number" min="0" max="1" step="0.1" value="0.2"></div>
    </div>
    <div class="flex-row" style="justify-content:space-between;margin-top:12px;"><span class="notice">keep a hard cap in your openai dashboard.</span><div class="flex-row" style="gap:6px;"><button id="aiTest" class="small-btn">test ai</button><button id="aiSave" class="small-btn">save</button><button id="aiClose" class="secondary small">close</button></div></div>
  </div>
</div>

<script>
const inputEl=document.getElementById('inputText');
const outputEl=document.getElementById('outputText');
const p1WrapEl=document.getElementById('pass1Preview');
const p1TextEl=document.getElementById('pass1Text');
document.getElementById('toggleTheme').onclick=()=>document.body.classList.toggle('dark');

// tools toggle
(function(){const btn=document.getElementById('toggleTools');const panel=document.getElementById('toolsPanel'); if(btn&&panel){ btn.onclick=()=>{ const vis=panel.style.display!=='none'; panel.style.display=vis?'none':'block'; btn.textContent=vis?'show tools':'hide tools'; }; }})();

// mic (optional)
let recognition,autoRestartMic=false; if('webkitSpeechRecognition'in window){recognition=new webkitSpeechRecognition();recognition.continuous=true;recognition.interimResults=true;recognition.onresult=e=>{let s="";for(let i=e.resultIndex;i<e.results.length;i++){if(e.results[i].isFinal)s+=e.results[i][0].transcript;}if(s.trim()!==''){inputEl.value+=(inputEl.value?' ':'')+s.toLowerCase();}};recognition.onend=()=>{if(autoRestartMic)recognition.start();};}
document.getElementById('startMic').onclick=()=>{if(recognition){autoRestartMic=true;recognition.start();}else{alert('speech not available in this browser.')}};
document.getElementById('stopMic').onclick =()=>{if(recognition){autoRestartMic=false;recognition.stop();}};

// clear / copy
document.getElementById('clearInput').onclick =()=>{inputEl.value='';p1TextEl.value='';p1WrapEl.style.display='none';};
document.getElementById('copyNote').onclick  =()=>{outputEl.focus();outputEl.select();try{document.execCommand('copy');}catch{navigator.clipboard.writeText(outputEl.value);}};
document.getElementById('clearOutput').onclick=()=>{outputEl.value='';p1TextEl.value='';p1WrapEl.style.display='none';};
document.getElementById('clearAll').onclick   =()=>{inputEl.value='';outputEl.value='';p1TextEl.value='';p1WrapEl.style.display='none';localStorage.removeItem('lastNote');window.__extListForICD=null;};
document.getElementById('pasteDemo').onclick  =()=>{inputEl.value='l hamstring tight dull after running; worse with stairs and hip flexion. prefers warm water. swims 2x/week, runs 10â€“15 miles/week. infrared used post-acu. bowel: loose 2x/day; sleep: wakes 3am; urine: dark, frequent.'};

// ai settings
const aiDefaults={provider:'openai',baseUrl:'https://api.openai.com',model:'gpt-4o-mini',apiKey:'',apiVersion:'2024-02-15-preview',temperature:0.2};
function loadAIConfig(){try{return Object.assign({},aiDefaults,JSON.parse(localStorage.getItem('aiConfig')||'{}'));}catch{return {...aiDefaults};}}
function saveAIConfig(c){localStorage.setItem('aiConfig',JSON.stringify(c));}
document.getElementById('aiSettingsBtn').onclick=()=>{const c=loadAIConfig();['aiProvider','aiBaseUrl','aiModel','aiKey','aiApiVersion','aiTemp'].forEach(id=>{const el=document.getElementById(id); if(!el)return; el.value=(id==='aiTemp'?c.temperature:(c[{aiProvider:'provider',aiBaseUrl:'baseUrl',aiModel:'model',aiKey:'apiKey',aiApiVersion:'apiVersion'}[id]]));});document.getElementById('aiModalBackdrop').style.display='flex';};
document.getElementById('aiClose').onclick=()=>document.getElementById('aiModalBackdrop').style.display='none';
document.getElementById('aiSave').onclick =()=>{const c={provider:document.getElementById('aiProvider').value,baseUrl:document.getElementById('aiBaseUrl').value.trim()||aiDefaults.baseUrl,model:document.getElementById('aiModel').value.trim()||aiDefaults.model,apiKey:document.getElementById('aiKey').value.trim(),apiVersion:document.getElementById('aiApiVersion').value.trim()||aiDefaults.apiVersion,temperature:parseFloat(document.getElementById('aiTemp').value)||aiDefaults.temperature};saveAIConfig(c);document.getElementById('aiModalBackdrop').style.display='none';};
document.getElementById('aiTest').onclick=async()=>{const c=loadAIConfig();if(!c.apiKey){alert('paste your api key first.');return;}try{await aiChat(c,[{role:'system',content:'reply with {"ok":true} only (json).'}, {role:'user',content:'ping'}]);alert('ai test ok.');}catch(e){alert('ai test failed: '+(e?.message||e));}}

// normalizers
function normalizeLateralityText(s){if(!s)return s;s=s.replace(/bilateral|both/gi,'B').replace(/left/gi,'L').replace(/right/gi,'R').replace(/rt/gi,'R').replace(/lt/gi,'L');s=s.replace(/\(?([rlb])\)?(?=\s|:|;|,|\/|-|\)|$)/gi,(_m,g1)=>g1.toUpperCase());s=s.replace(/(^|[

])\s*[â€“\-â€¢]\s*([rlb])(?=\s|:)/gi,(_m,lead,side)=>`${lead}â€“ ${side.toUpperCase()}`);return s;}
function uppercaseMeridians(s){if(!s)return s;['lv','sp','gb','bl','st','lu','li','si','ht','pc','kd','cv','gv'].forEach(m=>{const r1=new RegExp(`\b${m}\b`,'gi');s=s.replace(r1,m.toUpperCase());const r2=new RegExp(`\b${m}\s?(\d+)`,'gi');s=s.replace(r2,(_a,n)=>`${m.toUpperCase()}${n}`);});s=s.replace(/yin\s?tang/gi,'yintang');return s;}
const norm=s=>uppercaseMeridians(normalizeLateralityText(s||''));

// gleaner
function gleanFromRaw(text){
  const t=(text||'').toLowerCase();
  const last=(src,rxs)=>{let b={idx:-1};rxs.forEach(rx=>{let m;const r=new RegExp(rx.source,rx.flags);while((m=r.exec(src))!==null){if(m.index>b.idx)b={idx:m.index};}});return b.idx;};
  const res={points:[],personal:[],contextPairs:[],extraHPI:[],activities:new Set(),aggravators:new Set(),qualities:new Set(),adjunctsUsed:new Set(),issueContexts:[]};
  let m; const ptRe=/(lv|sp|gb|bl|st|lu|li|si|ht|pc|kd|cv|gv)\s?(\d{1,2})|y[ i]?n\s?tang/gi; while((m=ptRe.exec(t))!==null){ if(/y[ i]?n\s?tang/.test(m[0])){ if(!res.points.includes('yintang')) res.points.push('yintang'); } else { const full=`${m[1].toUpperCase()}${m[2]}`; if(!res.points.includes(full)) res.points.push(full); } }
  let p; const pairRe=/([a-z ]{2,20})\s*:\s*([^.;

]+)/gi; while((p=pairRe.exec(t))!==null){ const k=(p[1]||'').trim(); const v=(p[2]||'').trim(); if(!k) continue; const kv=`${k}: ${v}`; if(!res.contextPairs.includes(kv)) res.contextPairs.push(kv); }
  const cold=last(t,[/likes?\s+(cold|iced)\s+water/g,/(prefers|drinks)\s+(cold|iced)\s+water/g,/thirst:\s*.*cold/g]);
  const warm=last(t,[/likes?\s+(hot|warm)\s+water/g,/(prefers|drinks)\s+(hot|warm)\s+water/g,/thirst:\s*.*(hot|warm)/g]);
  if(cold>=0||warm>=0){ res.personal.push(cold>warm?'prefers cold water':'prefers warm water'); }
  const sm=t.match(/favorite (?:season\s*is|season:)?\s*(spring|summer|fall|autumn|winter)/); if(sm) res.personal.push(`favorite season: ${sm[1]==='autumn'?'fall':sm[1]}`);
  if(/intense sitting|prolonged sitting|long sitting|desk job/.test(t)) res.personal.push('job: prolonged sitting');
  if(/going up stairs|up stairs|climbing stairs/.test(t)) res.extraHPI.push('pain going up stairs');
  if(/worse on the left/.test(t)) res.extraHPI.push('worse on the L');
  if(/bilateral knee/.test(t)) res.extraHPI.push('B knee pain');
  if(/runs?|running/.test(t)) res.activities.add('running');
  if(/swims?|swimming/.test(t)) res.activities.add('swimming');
  if(/cycles?|cycling/.test(t)) res.activities.add('cycling');
  if(/lifting|weights|strength training/.test(t)) res.activities.add('lifting/weights');
  if(/stairs?/.test(t)) res.aggravators.add('stairs');
  if(/bending forward|touching toes|hinge/.test(t)) res.aggravators.add('bending forward');
  if(/prolonged sitting|long sitting/.test(t)) res.aggravators.add('prolonged sitting');
  if(/hip flexion/.test(t)) res.aggravators.add('hip flexion');
  if(/hip extension/.test(t)) res.aggravators.add('hip extension');
  if(/running/.test(t)) res.aggravators.add('running');
  ['dull','sharp','stabbing','aching','burning','tingling','numb','throbbing','tight'].forEach(q=>{ if(new RegExp(`\b${q}\b`).test(t)) res.qualities.add(q); });
  if(/infrared|ir lamp|heat lamp/.test(t)) res.adjunctsUsed.add('infrared');
  if(/moxa|moxibustion/.test(t)) res.adjunctsUsed.add('moxa');
  if(/cupping/.test(t)) res.adjunctsUsed.add('cupping');
  if(/gua ?sha/.test(t)) res.adjunctsUsed.add('guasha');
  if(/estim|electro-?acupuncture/.test(t)) res.adjunctsUsed.add('estim');
  if(/tui ?na/.test(t)) res.adjunctsUsed.add('tui na');
  const regions=[]; const list=[{k:'hamstring',l:'hamstring'},{k:'gluteus medius|glute med',l:'gluteus medius'},{k:'piriformis',l:'piriformis'},{k:'knee',l:'knee'},{k:'hip',l:'hip'},{k:'low back|lumbar',l:'low back'}];
  list.forEach(rg=>{ const re=new RegExp(`\b(?:(r|l|right|left|bilateral|both)\s+)?(?:${rg.k})\b`,'gi'); let mm; while((mm=re.exec(t))!==null){ const raw=(mm[1]||'').toLowerCase(); const side=raw.startsWith('r')?'R':raw.startsWith('l')?'L':(raw?'B':''); regions.push({side,label:rg.l}); } });
  const agg=Array.from(res.aggravators), qual=Array.from(res.qualities), acts=Array.from(res.activities);
  regions.forEach(r=>{ const name=(r.side?`${r.side} `:'')+r.label; const bullets=[]; if(agg.length) bullets.push('aggravated by: '+agg.join(', ')); if(qual.length) bullets.push('quality: '+qual.join(', ')); if(acts.length) bullets.push('activity: '+acts.join(', ')); if(bullets.length) res.issueContexts.push({region:name,bullets}); });
  return res;
}

// ai caller
async function aiChat(cfg,messages){
  const base=(cfg.baseUrl||'https://api.openai.com').replace(/\/+$/,'');
  let url,headers,body; if(cfg.provider==='azure'){ url=`${base}/openai/deployments/${encodeURIComponent(cfg.model)}/chat/completions?api-version=${encodeURIComponent(cfg.apiVersion)}`; headers={'Content-Type':'application/json','api-key':cfg.apiKey}; body={temperature:cfg.temperature??0.2,response_format:{type:'json_object'},messages}; } else { url=`${base}/v1/chat/completions`; headers={'Content-Type':'application/json','Authorization':`Bearer ${cfg.apiKey}`}; body={model:cfg.model||'gpt-4o-mini',temperature:cfg.temperature??0.2,response_format:{type:'json_object'},messages}; }
  const resp=await fetch(url,{method:'POST',headers,body:JSON.stringify(body)}); if(!resp.ok){ let t=''; try{t=await resp.text();}catch{} throw new Error(`api ${resp.status}: ${t||'no server message'}`); }
  const data=await resp.json(); return data?.choices?.[0]?.message?.content||data?.choices?.[0]?.text||'';
}

// deduce tongue & pulse
function deduceTonguePulseFromClues(extList,glean){ const all=JSON.stringify(extList||[]).toLowerCase(); const clues=new Set(); if(/lv qi stagnation/.test(all)) clues.add('lv qi stagnation'); if(/blood stasis/.test(all)) clues.add('blood stasis'); if(/damp/.test(all)) clues.add('damp'); if(/heat/.test(all)) clues.add('heat'); if(/cold/.test(all)) clues.add('cold'); if(/yin def|yin deficiency/.test(all)) clues.add('yin deficiency'); if(/yang def|yang deficiency/.test(all)) clues.add('yang deficiency'); const personal=(glean?.personal||[]).join(' ').toLowerCase(); if(/prefers cold water/.test(personal)) clues.add('heat tendency'); if(/prefers warm water/.test(personal)) clues.add('cold tendency'); const tp={tongue:'deduced: not specified',pulse:'deduced: not specified'}; const setT=d=>tp.tongue='deduced: '+d, setP=d=>tp.pulse='deduced: '+d; if(clues.has('lv qi stagnation')) setP('wiry (esp. LV positions)'); if(clues.has('blood stasis')) setP(tp.pulse.includes('not specified')?'choppy':'choppy; plus prior'); if(clues.has('damp')) setP(tp.pulse.includes('not specified')?'slippery':tp.pulse+'; slippery'); if(clues.has('heat')||clues.has('yin deficiency')||/heat tendency/.test([...clues].join(' '))){ setT('red or slightly dry'); setP(tp.pulse.includes('not specified')?'rapid or thin':tp.pulse+'; rapid/thin'); } if(clues.has('cold')||clues.has('yang deficiency')||/cold tendency/.test([...clues].join(' '))){ setT(tp.tongue.includes('not specified')?'pale':tp.tongue+'; pale'); setP(tp.pulse.includes('not specified')?'tight or slow':tp.pulse+'; tight/slow'); } return tp; }

// confidence clamp (0.75â€“0.95), default 0.88
function coerceConfidence(v){ if(typeof v!=='number'||!isFinite(v)) return 0.88; if(v<0.75) return 0.88; if(v>0.95) return 0.95; return v; }

// herb fallback
function herbFallbackFromTCM(arr){ try{ const txt=(arr||[]).join('; ').toLowerCase(); const picks=[]; const push=x=>{ if(x && !picks.includes(x)) picks.push(x) }; if(/lv qi stagnation|liver qi/.test(txt)){ push('xiao yao wan'); if(/heat|irrit/.test(txt)) push('jia wei xiao yao wan'); } if(/blood stasis/.test(txt)) push('shen tong zhu yu wan'); if(/wind|cold|damp/.test(txt)&&/bi/.test(txt)){ push('du huo ji sheng wan'); push('juan bi wan'); } if(!picks.length) push('shen tong zhu yu wan'); return picks.slice(0,2); }catch{return ['shen tong zhu yu wan'];} }

// renderer
function ensureHipICD(extList,icdArr){ try{ const txt=JSON.stringify(extList).toLowerCase(); if(!txt.includes('hip')) return icdArr; const has=(icdArr||[]).some(x=>/m25\.55[129]/i.test(x)); if(has) return icdArr; let code='M25.559 pain in unspecified hip'; if(/(r\s?hip|right hip)/i.test(txt)) code='M25.551 pain in R hip'; else if(/(l\s?hip|left hip)/i.test(txt)) code='M25.552 pain in L hip'; return [...(icdArr||[]),code]; }catch{ return icdArr; } }
function renderNoteFromJSON(j){ function bullets(a){return(a||[]).map(s=>'â€“ '+(s||'')).join('
')} function sections(sec){ if(!sec||!sec.sections) return''; return sec.sections.map(s=>{ let h=s.header||''; let b=bullets(s.bullets||[]); h=uppercaseMeridians(normalizeLateralityText(h)); b=uppercaseMeridians(normalizeLateralityText(b)); return h+(b?'
'+b:''); }).join('
'); }
  let subjBlock=j.subjective||{sections:[]}; const clinical=[...((j.clinically_relevant||[])),...((j.qa_pairs||[]).map(q=>{const k=(q?.q||'').trim();const v=(q?.a||'').trim();return(k||v)?`${k}${(k&&v)?': ':''}${v}`:'';})).filter(Boolean)]; if(clinical.length){ subjBlock.sections=(subjBlock.sections||[]).concat([{header:'clinically relevant context',bullets:clinical}]); }
  const hpi='hpi:
â€“ '+norm(j.hpi||'followâ€‘up for pain and mobility concerns');
  const subj='subjective:
'+(sections(subjBlock)||'general
â€“ no specific subjective items captured');
  const obj='objective:
'+(sections(j.objective)||'');
  const pc=(j.personal_context&&j.personal_context.length)?('personal context:
'+bullets((j.personal_context||[]).map(norm))):'';
  const tongue='tongue:
'+norm(j.tongue||'deduced: not specified');
  const pulse='pulse:
'+norm(j.pulse||'deduced: not specified');
  const assess='assessment (including tcm diagnosis):
'+bullets((j.assessment?.bullets||[]).map(norm));
  const tcmdx='tcm diagnosis:
'+bullets((j.assessment?.tcm_dx||[]).map(norm));
  const principle='treatment principle:
'+bullets((j.treatment_principle||[]).map(norm));
  const plan=(()=>{ const ch=norm(j.acupuncture_plan?.channels||'LV, SP, GB, BL, ST as indicated; local ashi'); const pts=(j.acupuncture_plan?.points_used||[]).map(norm).join(', '); const ints=bullets((j.acupuncture_plan?.interventions||[]).map(norm)); const adj=bullets((j.acupuncture_plan?.adjuncts||[]).map(norm)); return ['acupuncture plan:','acupuncture','â€“ channels: '+ch,'â€“ points used: '+(pts||'as clinically indicated'),ints?ints:'','adjunct therapies',adj?adj:''].filter(Boolean).join('
'); })();
  let herbs='herbal recommendations (patent formulas):
'+bullets((j.herb_formulas||[]).map(norm)); if(!j.herb_formulas||!j.herb_formulas.length){ herbs='herbal recommendations (patent formulas):
'+bullets(herbFallbackFromTCM(j.assessment?.tcm_dx||[])); }
  const advice='advice:
'+bullets((j.advice||[]).map(norm));
  let icdArr=(j.icd10||[]).map(x=>normalizeLateralityText(x||'')); if(window.__extListForICD){ icdArr=ensureHipICD(window.__extListForICD,icdArr); }
  const icd=icdArr&&icdArr.length?('icd-10 codes:
'+bullets(icdArr)):'';
  const note=[hpi,'',subj,'',obj,'',pc?pc+'
':'',tongue,'',pulse,'',assess,'',tcmdx,'',principle,'',plan,'',herbs,'',advice,'','confidence & assumptions:
â€“ confidence: '+(typeof j.confidence==='number'?coerceConfidence(j.confidence).toFixed(2):'0.88'),(j.assumptions&&j.assumptions.length?bullets(j.assumptions.map(norm)):'') ,'',icd].join('
');
  return uppercaseMeridians(normalizeLateralityText(note));
}

// fallback composer (short)
function buildFinalJsonFromExtracts(extList,glean){ const H=[],M=[],R=[],T=[],PC=[],TCM=[],ICD=[],HERB=[],PTS=[],CR=[],QAP=[]; (extList||[]).forEach(e=>{ (e?.hpi_bits||[]).forEach(x=>H.push(x)); (e?.muscles||[]).forEach(m=>M.push(`${m.side||''} ${m.name||''}: ${(m.findings||[]).join('/')}`.trim())); (e?.rom||[]).forEach(x=>R.push(x)); (e?.muscle_tests||[]).forEach(x=>T.push(x)); (e?.personal_context||[]).forEach(x=>PC.push(x)); (e?.tcm_clues||[]).forEach(x=>TCM.push(x)); (e?.icd_candidates||[]).forEach(x=>ICD.push(x)); (e?.herb_candidates||[]).forEach(x=>HERB.push(x)); (e?.points_mentioned||[]).forEach(x=>PTS.push(x)); (e?.clinically_relevant||[]).forEach(x=>CR.push(x)); (e?.qa_pairs||[]).forEach(q=>{ const k=(q?.q||'').trim(); const v=(q?.a||'').trim(); if(k||v) QAP.push(`${k}${(k&&v)?': ':''}${v}`.trim()); }); }); const pcSet=new Set(PC); (glean?.personal||[]).forEach(x=>pcSet.add(x)); const pointsUsed=Array.from(new Set([...(glean?.points||[]),...PTS.map(p=>String(p).toUpperCase())])).filter(Boolean); const tp=deduceTonguePulseFromClues(extList,glean); const clinically=Array.from(new Set([...(CR||[]),...(QAP||[]),...((glean?.contextPairs)||[])])).slice(0,20); return { hpi:(H[0]||'followâ€‘up for pain and mobility concerns.'), subjective:{sections:[{header:'general',bullets:Array.from(new Set([...(glean?.extraHPI||[]),...H])).slice(0,8)}, ...(clinically.length?[{header:'clinically relevant context',bullets:clinically}]:[]), ...(glean?.issueContexts?.length?[{header:'issue-specific context',bullets:glean.issueContexts.map(ic=>`${ic.region}: ${ic.bullets.join('; ')}`)}]:[]) ]}, objective:{sections:[{header:'muscles',bullets:Array.from(new Set(M)).slice(0,10)},{header:'rom',bullets:Array.from(new Set(R)).slice(0,8)},{header:'muscle testing',bullets:Array.from(new Set(T)).slice(0,8)}].filter(x=>x.bullets.length)}, personal_context:Array.from(pcSet).slice(0,10), tongue:tp.tongue, pulse:tp.pulse, assessment:{bullets:Array.from(new Set([...(M.length?['myofascial involvement of hip stabilizers']:[]), ...(R.length?['functional limitation with stairs/hip flexion']:[])])).slice(0,4), tcm_dx:Array.from(new Set(TCM.length?TCM:['lv qi stagnation','blood stasis in the channels'])).slice(0,3)}, treatment_principle:['move qi and blood','relax hypertonic musculature'], acupuncture_plan:{channels:'LV, SP, GB, BL, ST as indicated; local ashi', points_used:pointsUsed.length?pointsUsed:['LV3','GB34','KD3'], interventions:['acupuncture',...(M.length?['motor/trigger point release']:[])], adjuncts:Array.from(glean?.adjunctsUsed||[])}, herb_formulas:HERB.length?Array.from(new Set(HERB)).slice(0,2):herbFallbackFromTCM(TCM), advice:['gentle mobility within tolerance','heat as indicated'], icd10:Array.from(new Set(ICD)).slice(0,4), confidence:0.88, assumptions:['constructed from passâ€‘1 facts + local parsing due to limited passâ€‘2 output'] } }

// driver
const tpModal=document.getElementById('tpModal'),tpProg=document.getElementById('tpProg'),tpStep=document.getElementById('tpStep'),tpLog=document.getElementById('tpLog'); document.getElementById('tpClose').onclick=()=>tpModal.style.display='none';
document.getElementById('aiGenerate').onclick=async()=>{
  const raw=(inputEl.value||'').trim(); if(!raw){alert('paste or dictate a transcript first.');return;}
  const cfg=loadAIConfig(); if(!cfg.apiKey){alert('open ai settings â†’ paste your api key â†’ test ai â†’ save.');return;}
  const glean=gleanFromRaw(raw);
  try{
    tpModal.style.display='flex'; tpStep.textContent='pass 1 of 2 â€” extracting factsâ€¦'; tpProg.style.width='0%'; tpLog.textContent='splitting transcriptâ€¦';
    const CHUNK_CHARS=8000, CHUNK_OVERLAP=800; const chunks=[]; let i=0; while(i<raw.length){const end=Math.min(raw.length,i+CHUNK_CHARS);chunks.push(raw.slice(i,end).trim()); if(end>=raw.length)break; i=end-CHUNK_OVERLAP; if(i<0)i=0; }
    const extList=[]; for(let k=0;k<chunks.length;k++){ tpProg.style.width=Math.round((k/Math.max(1,(chunks.length+1)))*100)+'%'; tpStep.textContent=`pass 1 â€” chunk ${k+1} of ${chunks.length}`; tpLog.textContent+=`
processing chunk ${k+1}/${chunks.length}â€¦`; const sys1=["you are a careful tcm-intake extractor for an acupuncture clinic.","task: read ONLY the provided transcript chunk and output STRICT JSON with facts (no rewriting, no opinions).","use lowercase for prose; laterality abbreviations r/l/b only.","json schema:","{","  "hpi_bits": ["short phrases"],","  "muscles": [ {"name":"gluteus medius","side":"r|l|b|","findings":["tight","tender","knots","adhesions","ropey"]} ],","  "rom": ["hip flexion limited ~20Â°"],","  "muscle_tests": ["hip abduction 4/5 r"],","  "subjective_sections": [ {"header":"string","bullets":["string"]} ],","  "objective_sections":  [ {"header":"string","bullets":["string"]} ],","  "personal_context": ["job: â€¦","habits: â€¦","preferences: â€¦"],","  "tcm_clues": ["lv qi stagnation","blood stasis","damp","heat","cold","deficiency","excess","wind","phlegm"],","  "points_mentioned": ["lv3","gb34","st44","yintang","pc6","li11"],","  "icd_candidates": ["m25.551 r hip pain"],","  "herb_candidates": ["jia wei xiao yao wan"],","  "clinically_relevant": ["label: value","anything clinically relevant"],","  "qa_pairs": [{"q":"bowel","a":"loose 3x/day"},{"q":"sleep","a":"wakes 3am"},{"q":"urine","a":"dark, frequent"}]","}","return ONLY the json."].join("
"); const content=await aiChat(cfg,[{role:'system',content:sys1},{role:'user',content:chunks[k]}]); let json; try{json=JSON.parse(content);}catch(e){const m=content.match(/\{[\s\S]*\}$/); if(m) json=JSON.parse(m[0]); else throw new Error('could not parse passâ€‘1 json'); } extList.push(json); }
    if(glean.points.length||glean.personal.length||glean.contextPairs.length||glean.extraHPI.length){ extList.push({hpi_bits:glean.extraHPI,personal_context:glean.personal,points_mentioned:glean.points.map(p=>p.toLowerCase()),clinically_relevant:glean.contextPairs}); }
    window.__extListForICD=extList;
    const outline=[],add=(h,a)=>{ if(a&&a.length){ outline.push(h+':'); Array.from(new Set(a)).forEach(s=>outline.push('â€“ '+s)); outline.push(''); } }; const H=[],M=[],R=[],T=[],PC=[],PTS=[],TCM=[],ICD=[],HERB=[],CR=[],QAP=[]; extList.forEach(e=>{ (e.hpi_bits||[]).forEach(x=>H.push(x)); (e.muscles||[]).forEach(m=>M.push(`${m.side||''} ${m.name||''}: ${(m.findings||[]).join('/')}`.trim())); (e.rom||[]).forEach(x=>R.push(x)); (e.muscle_tests||[]).forEach(x=>T.push(x)); (e.personal_context||[]).forEach(x=>PC.push(x)); (e.points_mentioned||[]).forEach(x=>PTS.push(x)); (e.tcm_clues||[]).forEach(x=>TCM.push(x)); (e.icd_candidates||[]).forEach(x=>ICD.push(x)); (e.herb_candidates||[]).forEach(x=>HERB.push(x)); (e.clinically_relevant||[]).forEach(x=>CR.push(x)); (e.qa_pairs||[]).forEach(q=>{ const k=(q?.q||'').trim(); const v=(q?.a||'').trim(); if(k||v) QAP.push(`${k}${(k&&v)?': ':''}${v}`.trim()); }); }); add('hpi highlights',H); add('muscles (raw)',M); add('rom (raw)',R); add('muscle tests (raw)',T); add('personal context',PC); add('points mentioned',PTS); add('clinically relevant',CR.concat(QAP)); add('tcm clues',TCM); add('icd candidates',ICD); add('herb candidates',HERB); p1TextEl.value=outline.join('
').trim()||'(no preview items extracted)'; p1WrapEl.style.display='block';
    const nothing=!extList.length||extList.every(e=>(!e?.hpi_bits||!e.hpi_bits.length)&&(!e?.muscles||!e.muscles.length)&&(!e?.rom||!e.rom.length)&&(!e?.subjective_sections||!e.subjective_sections.length)&&(!e?.objective_sections||!e.objective_sections.length)&&(!e?.points_mentioned||!e.points_mentioned.length)&&(!e?.personal_context||!e.personal_context.length)&&(!e?.clinically_relevant||!e.clinically_relevant.length)&&(!e?.qa_pairs||!e?.qa_pairs.length));
    if(nothing){ tpStep.textContent='stopped â€” nothing extracted'; tpLog.textContent+='
no facts captured in passâ€‘1.'; return; }
    tpStep.textContent='pass 2 of 2 â€” drafting final noteâ€¦'; tpProg.style.width='90%'; tpLog.textContent+='
consolidatingâ€¦';
    const sys2=["you are a tcm-savvy clinical scribe for an acupuncture practice.","use ALL extracted facts (array of chunk extracts) to write ONE consolidated note.","hard requirements:","- in HPI, list the top 3â€“5 chief issues with brief context (duration, location + laterality, aggravators/relievers, notable qualities).","- prose lowercase, but laterality must be R/L/B only (never write the words left/right/bilateral).","- tcm channels/points UPPERCASE (LV, KD, GB; LV3, GB34, etc.).","- objective: include muscles (with findings), rom, and muscle testing.","- include personal context (job/lifestyle/preferences like thermal/season).","- include clinically relevant context (key:value items or nuanced answers) as a section under subjective.","- if tongue/pulse not explicit, DEDUCE and label as deduced.","- assessment: include biomedical descriptors when appropriate (e.g., myofascial pain syndrome) alongside tcm.","- tcm dx must be standard patterns (e.g., lv qi stagnation; blood stasis in the channels; cold-damp bi; kd yang deficiency), not just a single word.","- treatment principle must be consistent with the tcm diagnosis (e.g., if 'move qi and blood' â†’ include 'qi & blood stagnation' or 'blood stasis' in dx).","- herbs REQUIRED (1â€“2 patent formulas) aligned with bensky/cam.","- icd10: choose 3â€“4 codes, with correct laterality when present.","- confidence realistic 0.75â€“0.95.","respond ONLY with the agreed json schema."].join('
');
    let finalJson; try{ const content2=await aiChat(cfg,[{role:'system',content:sys2},{role:'user',content:JSON.stringify({extracts:extList})}]); finalJson=JSON.parse(content2); }catch(e){ const m=(typeof e==='string'?e:'').match(/\{[\s\S]*\}$/); finalJson=m?JSON.parse(m[0]):{}; }
    const hasHpi=typeof finalJson?.hpi==='string'&&finalJson.hpi.trim().length>0; const hasObj=Array.isArray(finalJson?.objective?.sections)&&finalJson.objective.sections.some(s=>(s.bullets||[]).length);
    if(!hasHpi&&!hasObj){ finalJson=buildFinalJsonFromExtracts(extList,glean); }
    else{ const mergedClinical=Array.from(new Set([...(finalJson.clinically_relevant||[]),...((finalJson.qa_pairs||[]).map(q=>{const k=(q?.q||'').trim();const v=(q?.a||'').trim();return(k||v)?`${k}${(k&&v)?': ':''}${v}`:'';})).filter(Boolean),...(glean.contextPairs||[])])); if(mergedClinical.length) finalJson.clinically_relevant=mergedClinical; if(!finalJson?.acupuncture_plan?.points_used?.length&&glean.points.length){ finalJson.acupuncture_plan=finalJson.acupuncture_plan||{}; finalJson.acupuncture_plan.points_used=glean.points; } const pcSet=new Set(finalJson.personal_context||[]); (glean.personal||[]).forEach(x=>pcSet.add(x)); finalJson.personal_context=Array.from(pcSet); if(!finalJson.tongue||!finalJson.tongue.trim()||!finalJson.pulse||!finalJson.pulse.trim()){ const tp=deduceTonguePulseFromClues(extList,glean); finalJson.tongue=finalJson.tongue&&finalJson.tongue.trim()?finalJson.tongue:tp.tongue; finalJson.pulse=finalJson.pulse&&finalJson.pulse.trim()?finalJson.pulse:tp.pulse; } }
    finalJson.confidence=coerceConfidence(finalJson.confidence);
    const note=renderNoteFromJSON(finalJson);
    outputEl.value=note; localStorage.setItem('lastNote',note);
    tpProg.style.width='100%'; tpStep.textContent='done'; tpLog.textContent+=(!hasHpi&&!hasObj)?'
passâ€‘2 was thin â€” composed final note from passâ€‘1 + local parsing âœ”':'
completed âœ”';
  }catch(e){ tpStep.textContent='error'; tpLog.textContent+='
error: '+(e?.message||e); }
};

document.getElementById('duplicateLast').onclick=()=>{const last=localStorage.getItem('lastNote'); if(last) outputEl.value=last;};

// ===== presets wiring =====
const modules={"stress":"general
â€“ increased stress
â€“ emotional tension
","sleep":"general
â€“ difficulty falling asleep or staying asleep
","knee pain baseline":"B knee
â€“ pain/tightness
","shoulder baseline":"R/L shoulder
â€“ pain/tightness
"};
(function(){ const mb=document.getElementById('moduleButtons'), md=document.getElementById('moduleDropdown'); if(mb&&md){ for(const k in modules){ const b=document.createElement('button'); b.className='small-btn'; b.textContent=k; b.onclick=()=>{ inputEl.value += (inputEl.value?' ':'') + modules[k]; }; mb.appendChild(b); const o=document.createElement('option'); o.value=k; o.textContent=k; md.appendChild(o);} const ins=document.getElementById('insertModule'); if(ins) ins.onclick=()=>{ inputEl.value += (inputEl.value?' ':'') + modules[md.value]; }; }})();
let combos={"LV3 + LI4":"LV3, LI4","ST36 + SP6":"ST36, SP6","GB34 + GB41":"GB34, GB41","BL40 + KD3":"BL40, KD3","GV20 + yintang":"GV20, yintang"};
(function(){ const cb=document.getElementById('comboButtons'), cd=document.getElementById('comboDropdown'); if(cb&&cd){ for(const k in combos){ const b=document.createElement('button'); b.className='small-btn'; b.textContent=k; b.onclick=()=>{ inputEl.value += (inputEl.value?' ':'') + combos[k]; }; cb.appendChild(b); const o=document.createElement('option'); o.value=k; o.textContent=k; cd.appendChild(o);} const ins=document.getElementById('insertCombo'); if(ins) ins.onclick=()=>{ inputEl.value += (inputEl.value?' ':'') + combos[cd.value]; }; }})();
let herbFormulas={"jia wei xiao yao wan":"stress/irritability with heat signs","xiao yao wan":"lv qi stagnation with sp deficiency","chai hu shu gan wan":"lv qi stagnation, distention, pain","du huo ji sheng wan":"chronic wind-cold-damp bi with deficiency","shen tong zhu yu wan":"blood stasis pain, fixed stabbing pain","juan bi wan":"wind-cold-damp bi with obstruction","gui pi wan":"sp qi + ht blood deficiency (fatigue, sleep)","suan zao ren tang wan":"insomnia due to lv blood/yin deficiency"};
(function(){ const hb=document.getElementById('herbButtons'), hd=document.getElementById('herbDropdown'); if(hb&&hd){ for(const n in herbFormulas){ const b=document.createElement('button'); b.className='small-btn'; b.textContent=n; b.onclick=()=>{ inputEl.value += ` herbal: ${n}${herbFormulas[n] ? " ("+herbFormulas[n]+")" : ""}`; }; hb.appendChild(b); const o=document.createElement('option'); o.value=n; o.textContent=n; hd.appendChild(o);} const ins=document.getElementById('insertHerb'); if(ins) ins.onclick=()=>{ const n=hd.value; inputEl.value += ` herbal: ${n}${herbFormulas[n] ? " ("+herbFormulas[n]+")" : ""}`; }; }})();
const icdList=["M54.2 cervicalgia","M25.511 pain in R shoulder","M25.512 pain in L shoulder","M79.18 myofascial pain","M54.6 pain in thoracic spine","M54.50 low back pain, unspecified","M54.59 other low back pain","M25.551 pain in R hip","M25.552 pain in L hip","M25.559 pain in unspecified hip","M25.561 pain in R knee","M25.562 pain in L knee","G47.00 insomnia, unspecified","G47.09 other insomnia","R51.9 headache, unspecified"];
(function(){ const dd=document.getElementById('icdDropdown'); const add=document.getElementById('addICD'); if(dd&&add){ icdList.forEach(code=>{ const o=document.createElement('option'); o.value=code; o.textContent=code; dd.appendChild(o); }); add.onclick=()=>{ const code=dd.value; outputEl.value += (outputEl.value.trim().length?"
":"") + "icd-10: " + normalizeLateralityText(code); }; }})();
</script>
</body>
</html>
