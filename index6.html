<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>jmf acu • r2c-diagnostics</title>
<style>
:root{--bg:#fff;--text:#222;--muted:#666;--border:#e5e7eb;--accent:#4F3D5C;--ok:#BADA55;--warn:#E3B75D;--err:#E35D5D}
body{margin:0;font:16px/1.45 system-ui,Segoe UI,Helvetica,Arial;background:var(--bg);color:var(--text)}
.container{padding:16px;max-width:1100px;margin:0 auto}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between}
.hint{font-size:12px;color:var(--muted)}
textarea{width:100%;height:260px;padding:10px;border:1px solid var(--border);border-radius:12px}
button{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}
button.secondary{background:#666}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#f4f4f5;border:1px solid #e5e7eb;font-size:12px;color:#444}
#diagBar{display:none;position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid var(--border);padding:10px 16px}
#diagBar span{margin-right:8px}
#diagBar .ok{background:var(--ok)}
#diagBar .warn{background:var(--warn)}
#diagBar .err{background:var(--err);color:#fff}
#log{white-space:pre-wrap;border:1px solid var(--border);border-radius:12px;padding:10px;height:180px;overflow:auto;background:#fafafa}
#tpModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);align-items:center;justify-content:center}
#tpCard{width:92%;max-width:720px;background:#fff;border-radius:12px;border:1px solid var(--border);padding:14px}
.progress{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin:8px 0}
.progress>div{height:100%;width:0;background:var(--ok)}
</style>
</head>
<body>
<div id="diagBar"><span class="badge">r2c‑diagnostics</span><span id="diagStatus" class="badge">ready</span><button id="copyErr" class="secondary" style="float:right">copy error details</button></div>

<div class="container">
  <div class="header">
    <div>
      <h1 style="margin:0">jmf acu <span class="hint">• r2c‑diagnostics</span></h1>
      <div class="hint">diagnostics build: shows any hidden errors and network responses</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnAI" class="secondary">ai settings</button>
      <button id="btnCost" class="secondary">show cost</button>
    </div>
  </div>

  <div style="margin-top:12px"><textarea id="txt" placeholder="paste transcript here…"></textarea></div>
  <div style="display:flex;gap:8px;margin-top:8px">
    <button id="btnGen">ai generate note</button>
    <button id="btnDemo" class="secondary">paste demo</button>
    <button id="btnClear" class="secondary">clear</button>
  </div>

  <div style="margin-top:12px">
    <div class="hint">diagnostic log</div>
    <div id="log"></div>
  </div>

  <div id="cost" style="display:none;margin-top:12px;border:1px solid var(--border);border-radius:12px;padding:10px">
    <div style="display:flex;justify-content:space-between"><div><b>estimated cost (this month)</b></div><div id="capTxt" class="hint">$0 / $15</div></div>
    <div class="progress"><div id="capFill"></div></div>
    <div class="hint"><span id="usd" class="badge">$0.00</span> <span id="tin" class="badge">in: 0 tok</span> <span id="tout" class="badge">out: 0 tok</span></div>
  </div>
</div>

<div id="tpModal"><div id="tpCard"><h3 style="margin:0 0 6px">two‑pass generation</h3><div id="tpStep" class="hint">preparing…</div><div class="progress"><div id="tpFill"></div></div><div id="tpSmall" class="hint" style="max-height:120px;overflow:auto;white-space:pre-wrap"></div><div style="text-align:right;margin-top:8px"><button id="tpClose" class="secondary">close</button></div></div></div>

<script>
// simple helpers
const $=q=>document.querySelector(q);
function log(msg){ const el=$('#log'); el.textContent += (el.textContent?"\n":"") + msg; el.scrollTop=el.scrollHeight; }
function setDiag(status,kind){ const bar=$('#diagBar'); bar.style.display='block'; const s=$('#diagStatus'); s.textContent=status; s.className='badge ' + (kind||''); }

// local storage config
const CFG_KEY='aiConfig';
const DEF={provider:'openai',baseUrl:'https://api.openai.com',model:'gpt-4o-mini',apiKey:'',apiVersion:'2024-02-15-preview',temperature:0.2,monthlyCap:15,priceIn:0.15,priceOut:0.60};
function loadCfg(){ try{ return Object.assign({},DEF, JSON.parse(localStorage.getItem(CFG_KEY)||'{}')); }catch{ return {...DEF}; } }
function saveCfg(c){ localStorage.setItem(CFG_KEY, JSON.stringify(c)); }

// cost meter
const MKEY='costMeter';
function monthKey(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function loadMeter(){ const raw=localStorage.getItem(MKEY); let m={month:monthKey(),inTok:0,outTok:0}; if(raw){ try{m=JSON.parse(raw)||m;}catch{} } if(m.month!==monthKey()) m={month:monthKey(),inTok:0,outTok:0}; return m; }
function saveMeter(m){ localStorage.setItem(MKEY, JSON.stringify(m));}
function chars2tok(s){ return Math.ceil((s||'').length/4); }
function addUsage(i,o){ const m=loadMeter(); m.inTok+=Math.max(0,Math.floor(i||0)); m.outTok+=Math.max(0,Math.floor(o||0)); saveMeter(m); renderCost(); }
function renderCost(){ const cfg=loadCfg(); const m=loadMeter(); const dollars=(m.inTok/1e6)*cfg.priceIn + (m.outTok/1e6)*cfg.priceOut; $('#capTxt').textContent=`$${dollars.toFixed(2)} / $${cfg.monthlyCap}`; $('#usd').textContent=`$${dollars.toFixed(2)}`; $('#tin').textContent=`in: ${m.inTok.toLocaleString()} tok`; $('#tout').textContent=`out: ${m.outTok.toLocaleString()} tok`; const pct=cfg.monthlyCap?Math.min(100, Math.round((dollars/cfg.monthlyCap)*100)):0; const fill=$('#capFill'); fill.style.width=pct+'%'; fill.style.background = pct>=100?'var(--err)':(pct>=80?'var(--warn)':'var(--ok)'); }

// basic AI caller with rich logging
async function aiChat(cfg,messages){
  const base=(cfg.baseUrl||'').replace(/\/+$/,'');
  const inTok = messages.reduce((a,m)=>a+chars2tok(m.content||''),0);
  const start=Date.now();
  let url,headers,body;
  if(cfg.provider==='azure'){
    url=`${base}/openai/deployments/${encodeURIComponent(cfg.model)}/chat/completions?api-version=${encodeURIComponent(cfg.apiVersion)}`;
    headers={'Content-Type':'application/json','api-key':cfg.apiKey};
    body={temperature:cfg.temperature??0.2,response_format:{type:'json_object'},messages};
  }else{
    url=`${base}/v1/chat/completions`;
    headers={'Content-Type':'application/json','Authorization':`Bearer ${cfg.apiKey}`};
    body={model:cfg.model||'gpt-4o-mini',temperature:cfg.temperature??0.2,response_format:{type:'json_object'},messages};
  }
  log(`[aiChat] POST ${url}`);
  let respText='';
  try{
    const resp = await fetch(url,{method:'POST',headers,body:JSON.stringify(body)});
    respText = await resp.text();
    log(`[aiChat] status: ${resp.status} in ${Date.now()-start}ms`);
    if(!resp.ok){ setDiag(`api ${resp.status}`, 'err'); throw new Error(`API ${resp.status}: ${respText}`); }
    let data; try{ data=JSON.parse(respText);}catch(parseErr){ setDiag('json parse error','err'); throw new Error('could not parse json: '+(respText||'empty')); }
    const content = data?.choices?.[0]?.message?.content || data?.choices?.[0]?.text || '';
    addUsage(inTok, chars2tok(content));
    return content;
  }catch(e){ log('[aiChat] ERROR: '+(e?.message||e)); throw e; }
}

// two-pass driver (minimal, with strong try/catch)
async function generate(){
  const text = ($('#txt').value||'').trim();
  if(!text){ alert('paste a transcript first'); return; }
  const cfg = loadCfg();
  if(!cfg.apiKey){ alert('open ai settings → paste your api key → save'); return; }
  setDiag('running…');
  $('#tpModal').style.display='flex'; $('#tpStep').textContent='pass 1 of 2 — extracting facts…'; $('#tpFill').style.width='10%'; $('#tpSmall').textContent='splitting transcript…';

  try{
    const sys1 = [
      'you are a careful tcm-intake extractor for an acupuncture clinic.',
      'read ONLY the provided transcript and return STRICT JSON with facts (no prose).',
      'json keys: hpi_bits[], muscles[], rom[], muscle_tests[], personal_context[], tcm_clues[], points_mentioned[], icd_candidates[], herb_candidates[], clinically_relevant[], qa_pairs[]',
      'use lowercase for prose; laterality r/l/b.'
    ].join('\n');

    const content1 = await aiChat(cfg,[{role:'system',content:sys1},{role:'user',content:text}]);
    $('#tpFill').style.width='55%';
    let ext; try{ ext = JSON.parse(content1); }catch(e){ setDiag('pass‑1 parse error','err'); log('[pass1] parse error: '+e.message+'\nraw: '+content1); alert('pass‑1 could not parse JSON. see log.'); return; }
    $('#tpSmall').textContent = 'pass1 keys: '+Object.keys(ext||{}).join(', ');

    $('#tpStep').textContent='pass 2 of 2 — drafting final note…'; $('#tpFill').style.width='70%';
    const sys2 = [
      'you are a tcm-savvy clinical scribe for an acupuncture practice.',
      'use ALL extracted facts to write ONE consolidated note in our schema.',
      'hard requirements:',
      '- hpi lists top 3–5 issues w/ duration, location + R/L/B, aggravators, qualities.',
      '- tcm channels/points UPPERCASE; laterality abbreviations R/L/B only.',
      '- objective includes muscles, rom, muscle testing.',
      '- include personal context and clinically relevant context.',
      '- if tongue/pulse not explicit, DEDUCE and label as deduced.',
      '- tcm dx must be standard patterns; treatment principle consistent with dx.',
      '- herbs required (1–2 patent formulas).',
      '- icd10: 3–4 codes with correct laterality.',
      '- confidence 0.75–0.95.',
      'respond ONLY with the agreed json.'
    ].join('\n');

    const content2 = await aiChat(cfg,[{role:'system',content:sys2},{role:'user',content:JSON.stringify({extracts:[ext]})}]);
    $('#tpFill').style.width='85%';
    let final; try{ final = JSON.parse(content2); }catch(e){ setDiag('pass‑2 parse error','err'); log('[pass2] parse error: '+e.message+'\nraw: '+content2); alert('pass‑2 could not parse JSON. see log.'); return; }

    $('#tpFill').style.width='100%'; $('#tpStep').textContent='done';
    setDiag('done','ok');
    // show the resulting note in the log (diagnostics build only)
    log('[final] hpi: '+(final.hpi||'(none)'));
    log('[final] confidence: '+(typeof final.confidence==='number'?final.confidence.toFixed(2):'(none)'));
    alert('note generated. scroll diagnostic log to review.');
  }catch(e){
    setDiag('error','err');
    alert('generation error: '+(e?.message||e));
  }
}

// wire UI
$('#btnDemo').onclick=()=>{$('#txt').value='l hamstring tight dull after running; worse with stairs and hip flexion. prefers warm water. swims 2x/week, runs 10–15 miles/week. infrared used post-acu. bowel: loose 2x/day; sleep: wakes 3am; urine: dark, frequent.';};
$('#btnClear').onclick=()=>{$('#txt').value=''; $('#log').textContent=''; setDiag('ready');};
$('#btnGen').onclick=generate;
$('#btnCost').onclick=()=>{ const c=$('#cost'); c.style.display = (c.style.display==='none')?'block':'none'; renderCost(); };
$('#copyErr').onclick=()=>{navigator.clipboard.writeText($('#log').textContent||''); alert('diagnostic log copied');};

// simple AI settings prompt (no modal to keep file compact)
$('#btnAI').onclick=()=>{
  const cfg=loadCfg();
  const prov = prompt('provider (openai/azure):', cfg.provider)||cfg.provider;
  const base = prompt('base url:', cfg.baseUrl)||cfg.baseUrl;
  const model= prompt(prov==='azure'?'deployment name:':'model:', cfg.model)||cfg.model;
  const key  = prompt('api key (sk-… or azure key):', cfg.apiKey)||cfg.apiKey;
  const ver  = prov==='azure' ? (prompt('azure api version:', cfg.apiVersion)||cfg.apiVersion) : cfg.apiVersion;
  const cap  = parseFloat(prompt('monthly cap $:', cfg.monthlyCap)||cfg.monthlyCap)||cfg.monthlyCap;
  const pin  = parseFloat(prompt('$ per 1M input tokens:', cfg.priceIn)||cfg.priceIn)||cfg.priceIn;
  const pout = parseFloat(prompt('$ per 1M output tokens:', cfg.priceOut)||cfg.priceOut)||cfg.priceOut;
  const temp = parseFloat(prompt('temperature (0–1):', cfg.temperature)||cfg.temperature)||cfg.temperature;
  saveCfg({provider:prov,baseUrl:base,model,apiKey:key,apiVersion:ver,monthlyCap:cap,priceIn:pin,priceOut:pout,temperature:temp});
  setDiag('ai settings saved','ok');
};

setDiag('ready');
</script>
</body>
</html>
