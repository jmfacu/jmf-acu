<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>jmf acu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- iPad/iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="jmf acu">
  <meta name="theme-color" content="#4F3D5C">

  <!-- home‚Äëscreen icon (ensure icon-180.png sits next to index.html) -->
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png?v=6">
  <link rel="icon" sizes="180x180" href="icon-180.png?v=6">

  <style>
  :root {
    --bg: #ffffff;
    --text: #444444;
    --muted: #666666;

    --card-bg: #ffffff;
    --border: #e5e7eb;

    --accent: #4F3D5C;      /* purple */
    --accent-text: #ffffff;
    --accent-green: #BADA55; /* green */

    --secondary: #666666;
    --danger: #4F3D5C;

    --font-heading: "Avenir Next", Avenir, -apple-system, system-ui, "Helvetica Neue", Helvetica, Arial, sans-serif;
    --font-body:    "Avenir Next", Avenir, -apple-system, system-ui, "Helvetica Neue", Helvetica, Arial, sans-serif;

    --radius: 12px;
  }
  .dark {
    --bg: #121212; --text: #e6e6e6; --muted: #b3b3b3;
    --card-bg: #1b1b1b; --border: #2a2a2a;
    --accent: #4F3D5C; --accent-text: #ffffff;
    --secondary: #666666; --danger: #4F3D5C; --accent-green: #BADA55;
  }

  * { box-sizing: border-box; }
  body {
    margin:0; padding:0; background:var(--bg); color:var(--text);
    font-family:var(--font-body); font-weight:300;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .container { padding:16px; max-width:1100px; margin:0 auto; }
  .header { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px; }

  h1, h2, h3, .section-title { font-family:var(--font-heading); font-weight:400; color:var(--text); }
  h1 { font-size:28px; margin:0; text-transform:lowercase; }
  .section-title { font-size:20px; font-weight:600; margin-top:20px; text-transform:lowercase; color:var(--accent); }
  .notice { font-size:12px; color:var(--muted); margin-top:6px; }

  textarea, input[type="text"], select {
    width:100%; padding:10px; font-size:16px;
    background:var(--card-bg); color:var(--text);
    border:1px solid var(--border); border-radius:var(--radius);
  }
  textarea.output-box { height:420px; white-space:pre-wrap; }

  hr { border:none; border-top:1px solid var(--border); margin:16px 0; }
  .flex-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  #comboButtons, #moduleButtons, #herbButtons { display:flex; flex-wrap:wrap; gap:6px; }

  button {
    padding:12px 16px; margin:4px 0; border:none; border-radius:var(--radius);
    font-size:16px; background:var(--accent); color:var(--accent-text);
    cursor:pointer; text-transform:lowercase; letter-spacing:0.2px;
  }
  button.secondary { background:var(--secondary); color:#fff; }
  button.danger { background:var(--danger); color:#fff; }
  .small-btn { padding:6px 10px; font-size:14px; background:var(--accent-green); color:#0b1324; border-radius:var(--radius); }
  button:hover { filter:brightness(0.98); } button:active { transform:translateY(1px); }
  select:focus, textarea:focus, input[type="text"]:focus { outline:2px solid rgba(186,218,85,0.45); border-color:var(--accent-green); }

  .brand-btn {
    display:inline-flex; flex-direction:column; align-items:center; justify-content:center;
    width:84px; height:84px; padding:0; background:var(--accent); color:#fff; border-radius:18px;
    line-height:1.05; text-transform:lowercase; font-family:var(--font-heading); font-weight:600;
  }
  .brand-btn span { display:block; font-size:22px; letter-spacing:0.5px; }
  #toggleTheme.small { padding:8px 10px; font-size:14px; border-radius:10px; }
  .chip { padding:6px 10px; border-radius:999px; background:#F3F8DB; border:1px solid #CFE78E; color:var(--text); font-weight:400; }

  /* ===== two-pass progress modal ===== */
  .modal-backdrop {
    display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:9999;
    align-items:center; justify-content:center; padding:16px;
  }
  .modal {
    width:100%; max-width:720px; background:var(--card-bg); color:var(--text);
    border:1px solid var(--border); border-radius:16px; padding:16px;
  }
  .progress-bar { height:10px; width:100%; background:#eee; border-radius:999px; overflow:hidden; margin:8px 0 12px; }
  .progress-bar > div { height:100%; width:0%; background:var(--accent-green); transition:width .25s ease; }
  .log { max-height:140px; overflow:auto; background:#fafafa; border:1px solid var(--border); border-radius:8px; padding:8px; font-size:13px; }

  /* ===== pass-1 preview panel ===== */
  .preview { margin-top:12px; padding:12px; border:1px solid var(--border); border-radius:12px; background:#fdfdfd; }
  .preview h3 { margin:0 0 8px; font-size:18px; color:var(--accent); }
  .preview textarea { height:160px; white-space:pre-wrap; }

  /* ===== cost meter (card) ===== */
  .cost-card {
    display:flex; flex-direction:column; gap:6px;
    min-width:280px; max-width:420px;
    background:#fafafa; border:1px solid var(--border); border-radius:12px; padding:10px 12px;
  }
  .cost-header { display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .cost-nums { font-size:12px; color:var(--muted); }
  .cost-strong { font-weight:600; color:var(--text); }
  .cost-bar { height:8px; width:100%; background:#eee; border-radius:999px; overflow:hidden; }
  .cost-bar > div { height:100%; width:0%; background:#BADA55; transition:width .25s ease; }
  .cost-note { font-size:11px; color:var(--muted); }
  .cost-warn { color:#8a6d3b; }
  .cost-danger { color:#9c2b2b; }
  .cost-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:12px; color:var(--muted); }
  .pill { padding:2px 8px; border-radius:99px; background:#f1f5f9; border:1px solid #e2e8f0; color:#475569; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div style="display:flex; align-items:center; gap:12px;">
      <button class="brand-btn" aria-label="jmf acu"><span>jmf</span><span>acu</span></button>
      <div>
        <h1>jmf acu</h1>
        <div class="notice">local ui. you control ai usage. (speech requires internet.)</div>
      </div>
    </div>

    <!-- cost meter card -->
    <div class="cost-card" id="costCard">
      <div class="cost-header">
        <div style="font-size:14px; font-weight:600; color:var(--accent);">estimated cost (this month)</div>
        <div class="cost-nums" id="costCapText">$0 / $15</div>
      </div>
      <div class="cost-bar"><div id="costBarFill"></div></div>
      <div class="cost-row">
        <span class="pill" id="costDollars">$0.00</span>
        <span class="pill" id="costTokensIn">in: 0 tok</span>
        <span class="pill" id="costTokensOut">out: 0 tok</span>
      </div>
      <div class="cost-note" id="costNote">defaults assume gpt‚Äë4o‚Äëmini ($0.15 in / $0.60 out per 1m tok). update in ai settings if you switch models.</div>
    </div>

    <div class="flex-row" style="gap:6px;">
      <button id="aiSettingsBtn" class="small-btn">ai settings</button>
      <button id="toggleTheme" class="secondary small" title="toggle dark / light">toggle</button>
    </div>
  </div>

  <div class="section-title">transcript input</div>
  <textarea id="inputText" placeholder="paste transcript or use microphone..."></textarea>
  <div class="flex-row">
    <button id="startMic">üé§ start dictation</button>
    <button id="stopMic" class="secondary">stop dictation</button>
    <button id="clearInput" class="danger">clear input</button>
  </div>

  <div class="section-title">ai generation (two‚Äëpass)</div>
  <div class="flex-row">
    <button id="aiGenerate">ai generate note</button>
    <button id="duplicateLast" class="secondary">duplicate last</button>
  </div>
  <div class="notice">you edit first, then click generate. pass 1 extracts facts (with preview), pass 2 writes the final note.</div>

  <div class="preview" id="pass1Preview" style="display:none;">
    <h3>ai summary preview (from pass 1)</h3>
    <div class="notice">this shows what the ai captured from your transcript before drafting the final note.</div>
    <textarea id="pass1Text" readonly></textarea>
  </div>

  <div class="section-title">quick modules</div>
  <div id="moduleButtons"></div>
  <div class="flex-row">
    <select id="moduleDropdown"></select>
    <button id="insertModule" class="small-btn">insert</button>
  </div>

  <div class="section-title">acupuncture point combos</div>
  <div id="comboButtons"></div>
  <div class="flex-row">
    <select id="comboDropdown"></select>
    <button id="insertCombo" class="small-btn">insert</button>
  </div>

  <div class="section-title">save custom combo</div>
  <div class="flex-row">
    <input id="customComboName" type="text" placeholder="combo name" style="flex:1%;">
    <input id="customComboPoints" type="text" placeholder="points (e.g. LV3, SP6)" style="flex:1%;">
    <button id="saveCombo" class="small-btn">save combo</button>
  </div>

  <div class="section-title">herbal recommendations (patent formulas)</div>
  <div id="herbButtons"></div>
  <div class="flex-row">
    <select id="herbDropdown"></select>
    <button id="insertHerb" class="small-btn">add formula</button>
  </div>

  <div class="section-title">save custom patent formula</div>
  <div class="flex-row">
    <input id="customHerbName" type="text" placeholder="formula name (e.g. jia wei xiao yao wan)" style="flex: 1%;">
    <input id="customHerbNote" type="text" placeholder="brief note/indication (optional)" style="flex: 1%;">
    <button id="saveHerb" class="small-btn">save formula</button>
  </div>

  <div class="section-title">icd-10 codes</div>
  <div class="flex-row">
    <select id="icdDropdown"></select>
    <button id="addICD" class="small-btn">add to output</button>
  </div>

  <div class="section-title">output note</div>
  <textarea id="outputText" class="output-box" placeholder="your formatted note will appear here‚Ä¶"></textarea>
  <div class="flex-row">
    <button id="copyNote">copy to clipboard</button>
    <button id="clearOutput" class="danger">clear output</button>
  </div>

  <hr>
  <div class="notice">tip: add this page to your ipad home screen from safari ‚Üí share ‚Üí add to home screen (enable ‚Äúopen as web app‚Äù).</div>
</div>

<!-- two-pass progress modal -->
<div id="tpModal" class="modal-backdrop">
  <div class="modal">
    <h2>generating note (two‚Äëpass)</h2>
    <div id="tpStep" class="notice">preparing‚Ä¶</div>
    <div class="progress-bar"><div id="tpProg"></div></div>
    <div class="log" id="tpLog"></div>
    <div style="text-align:right; margin-top:10px;">
      <button id="tpClose" class="secondary small">close</button>
    </div>
  </div>
</div>

<!-- AI settings modal -->
<div id="aiModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h2>ai settings</h2>
    <p class="notice">your key is stored only on this device (localStorage). set a monthly cap here for the in‚Äëapp meter (you can also keep a hard cap in the openai dashboard).</p>

    <div class="grid">
      <div>
        <label>provider</label>
        <select id="aiProvider">
          <option value="openai">openai (api.openai.com)</option>
          <option value="azure">azure openai</option>
        </select>
      </div>
      <div>
        <label>model / deployment</label>
        <input id="aiModel" type="text" placeholder="openai: gpt-4o-mini  |  azure: your-deployment-name">
      </div>
      <div>
        <label>api key</label>
        <input id="aiKey" type="text" placeholder="paste your api key">
      </div>
      <div>
        <label>base url</label>
        <input id="aiBaseUrl" type="text" placeholder="openai: https://api.openai.com  |  azure: https://YOUR-RESOURCE.openai.azure.com">
      </div>
      <div>
        <label>azure api version (if azure)</label>
        <input id="aiApiVersion" type="text" placeholder="e.g., 2024-02-15-preview">
      </div>
      <div>
        <label>temperature</label>
        <input id="aiTemp" type="number" min="0" max="1" step="0.1" value="0.2">
      </div>

      <!-- cost meter config -->
      <div>
        <label>monthly cap ($) ‚Äî in‚Äëapp meter</label>
        <input id="aiCap" type="number" min="0" step="1" value="15">
      </div>
      <div>
        <label>price ‚Äî input ($ / 1M tokens)</label>
        <input id="aiPriceIn" type="number" min="0" step="0.01" value="0.15">
      </div>
      <div>
        <label>price ‚Äî output ($ / 1M tokens)</label>
        <input id="aiPriceOut" type="number" min="0" step="0.01" value="0.60">
      </div>
    </div>

    <div class="flex-row" style="justify-content:space-between; margin-top:12px;">
      <span class="notice">tip: set your openai dashboard hard cap too (e.g., $15). this in‚Äëapp meter is an estimate for peace of mind.</span>
      <div class="flex-row" style="gap:6px;">
        <button id="aiTest" class="small-btn">test ai</button>
        <button id="aiSave" class="small-btn">save</button>
        <button id="aiClose" class="secondary small">close</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   theme toggle
========================= */
document.getElementById("toggleTheme").onclick = () => {
  document.body.classList.toggle("dark");
};

/* =========================
   speech recognition (final results only)
========================= */
let recognition, autoRestartMic = false;
if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();
  recognition.continuous = true; recognition.interimResults = true;
  recognition.onresult = (event) => {
    let finalText = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) finalText += event.results[i][0].transcript;
    }
    if (finalText.trim() !== "") {
      const input = document.getElementById("inputText");
      input.value += (input.value ? " " : "") + finalText.toLowerCase();
    }
  };
  recognition.onend = () => { if (autoRestartMic) recognition.start(); };
}
document.getElementById("startMic").onclick = () => {
  if (recognition) { autoRestartMic = true; recognition.start(); }
  else { alert("speech recognition not available in this browser."); }
};
document.getElementById("stopMic").onclick = () => {
  if (recognition) { autoRestartMic = false; recognition.stop(); }
};

/* =========================
   input & clipboard
========================= */
document.getElementById("clearInput").onclick = () => { document.getElementById("inputText").value = ""; };
document.getElementById("copyNote").onclick = () => {
  const out = document.getElementById("outputText");
  out.focus(); out.select();
  try { document.execCommand("copy"); } catch (e) { navigator.clipboard.writeText(out.value); }
};
document.getElementById("clearOutput").onclick = () => { document.getElementById("outputText").value = ""; };

/* =========================
   ICD favorites
========================= */
const icdList = [
  "M54.2 cervicalgia","M25.511 pain in R shoulder","M25.512 pain in L shoulder",
  "M79.10 myalgia, unspecified","M79.11 myalgia of mastication muscle","M79.12 myalgia of auxiliary muscles, head/neck","M79.18 myofascial pain",
  "M54.6 pain in thoracic spine","M54.50 low back pain, unspecified","M54.51 vertebrogenic low back pain","M54.59 other low back pain",
  "M25.551 pain in R hip","M25.552 pain in L hip","M25.561 pain in R knee","M25.562 pain in L knee",
  "M25.571 pain in R ankle/foot","M25.572 pain in L ankle/foot",
  "G47.00 insomnia, unspecified","G47.09 other insomnia",
  "R14.0 abdominal distension","R14.1 gas pain","R14.2 eructation","R14.3 flatulence",
  "R11.0 nausea","R11.2 nausea with vomiting",
  "M25.521 pain in R elbow","M25.522 pain in L elbow",
  "G43.909 migraine, unsp, not intractable, w/o status migrainosus",
  "R51.9 headache, unspecified",
  "M26.621 R TMJ pain","M26.622 L TMJ pain","M26.623 B TMJ pain",
  "H93.11 tinnitus R","H93.12 tinnitus L","H93.13 tinnitus B"
];
const icdDropdown = document.getElementById("icdDropdown");
icdList.forEach(code => {
  const opt = document.createElement("option");
  opt.value = code; opt.textContent = code; icdDropdown.appendChild(opt);
});
document.getElementById("addICD").onclick = () => {
  const code = icdDropdown.value, out = document.getElementById("outputText");
  out.value += (out.value.trim().length ? "\n" : "") + "icd-10: " + code.toLowerCase();
};

/* =========================
   quick modules
========================= */
const modules = {
  "stress": "general\n‚Äì increased stress\n‚Äì emotional tension\n",
  "sleep": "general\n‚Äì difficulty falling asleep or staying asleep\n",
  "knee pain baseline": "B knee\n‚Äì pain/tightness\n",
  "shoulder baseline": "R/L shoulder\n‚Äì pain/tightness\n"
};
const moduleButtons = document.getElementById("moduleButtons");
const moduleDropdown = document.getElementById("moduleDropdown");
for (const key in modules) {
  const b = document.createElement("button");
  b.className = "small-btn"; b.textContent = key;
  b.onclick = () => { document.getElementById("inputText").value += " " + modules[key]; };
  moduleButtons.appendChild(b);
  const opt = document.createElement("option");
  opt.value = key; opt.textContent = key; moduleDropdown.appendChild(opt);
}
document.getElementById("insertModule").onclick = () => {
  const val = moduleDropdown.value;
  document.getElementById("inputText").value += " " + modules[val];
};

/* =========================
   combos with custom saving
========================= */
let combos = {
  "LV3 + LI4": "LV3, LI4","ST36 + SP6":"ST36, SP6","GB34 + GB41":"GB34, GB41","BL40 + KD3":"BL40, KD3","GV20 + yintang":"GV20, yintang"
};
const comboButtons = document.getElementById("comboButtons");
const comboDropdown = document.getElementById("comboDropdown");
function refreshCombos() {
  comboButtons.innerHTML = ""; comboDropdown.innerHTML = "";
  for (const key in combos) {
    const b = document.createElement("button");
    b.className = "small-btn"; b.textContent = key;
    b.onclick = () => { document.getElementById("inputText").value += " " + combos[key]; };
    comboButtons.appendChild(b);
    const opt = document.createElement("option");
    opt.value = key; opt.textContent = key; comboDropdown.appendChild(opt);
  }
}
document.getElementById("insertCombo").onclick = () => {
  const val = comboDropdown.value;
  document.getElementById("inputText").value += " " + combos[val];
};
document.getElementById("saveCombo").onclick = () => {
  const name = document.getElementById("customComboName").value.trim();
  const pts = document.getElementById("customComboPoints").value.trim();
  if (!name || !pts) return;
  combos[name] = pts; localStorage.setItem("savedCombos", JSON.stringify(combos));
  refreshCombos(); document.getElementById("customComboName").value = ""; document.getElementById("customComboPoints").value = "";
};
const savedCombos = localStorage.getItem("savedCombos");
if (savedCombos) { try { combos = JSON.parse(savedCombos); } catch (e) {} }
refreshCombos();

/* =========================
   herbs (patent formulas only)
========================= */
let herbFormulas = {
  "jia wei xiao yao wan":"stress/irritability with heat signs",
  "xiao yao wan":"lv qi stagnation with sp deficiency",
  "chai hu shu gan wan":"lv qi stagnation, hypochondriac distention, pain",
  "shu jin wan":"sinew/blood stasis, pain and stiffness",
  "du huo ji sheng wan":"chronic wind-cold-damp bi with deficiency",
  "shen tong zhu yu wan":"blood stasis pain, fixed stabbing pain",
  "juan bi wan":"wind-cold-damp bi with obstruction",
  "yu ping feng wan":"wei qi support",
  "gui pi wan":"sp qi + ht blood deficiency (fatigue, sleep)",
  "tian wang bu xin dan":"ht/kd yin deficiency insomnia, palpitations",
  "suan zao ren tang wan":"insomnia due to lv blood/yin deficiency",
  "ban xia hou po wan":"plum-pit qi (phlegm + qi stagnation)",
  "bao he wan":"food stagnation",
  "zuo gui wan":"kd yin deficiency",
  "you gui wan":"kd yang deficiency"
};
const herbButtons = document.getElementById("herbButtons");
const herbDropdown = document.getElementById("herbDropdown");
function refreshHerbs() {
  herbButtons.innerHTML = ""; herbDropdown.innerHTML = "";
  for (const name in herbFormulas) {
    const b = document.createElement("button");
    b.className = "small-btn"; b.textContent = name;
    b.onclick = () => { addHerbToList(name, herbFormulas[name]); };
    herbButtons.appendChild(b);
    const opt = document.createElement("option");
    opt.value = name; opt.textContent = name; herbDropdown.appendChild(opt);
  }
}
function addHerbToList(name, note) {
  const key = "currentHerbs"; const existing = localStorage.getItem(key);
  let arr = []; if (existing) { try { arr = JSON.parse(existing) || []; } catch(e) { arr = []; } }
  if (!arr.find(h => h.name === name)) {
    arr.push({ name, note }); localStorage.setItem(key, JSON.stringify(arr));
  }
  const input = document.getElementById("inputText");
  input.value += ` herbal: ${name}${note ? " (" + note + ")" : ""}`;
}
document.getElementById("insertHerb").onclick = () => {
  const name = herbDropdown.value; addHerbToList(name, herbFormulas[name]);
};
document.getElementById("saveHerb").onclick = () => {
  const nm = document.getElementById("customHerbName").value.trim().toLowerCase();
  const nt = document.getElementById("customHerbNote").value.trim().toLowerCase();
  if (!nm) return;
  herbFormulas[nm] = nt || "";
  localStorage.setItem("savedHerbs", JSON.stringify(herbFormulas));
  refreshHerbs();
  document.getElementById("customHerbName").value = ""; document.getElementById("customHerbNote").value = "";
};
const savedHerbs2 = localStorage.getItem("savedHerbs");
if (savedHerbs2) { try { herbFormulas = JSON.parse(savedHerbs2); } catch(e) {} }
refreshHerbs();

/* =========================
   AI settings (stored locally)
========================= */
const aiDefaults = {
  provider: "openai",
  baseUrl: "https://api.openai.com",
  model: "gpt-4o-mini",
  apiKey: "",
  apiVersion: "2024-02-15-preview",
  temperature: 0.2,

  // cost meter defaults (gpt‚Äë4o‚Äëmini)
  monthlyCap: 15,        // dollars
  priceIn: 0.15,         // $ per 1M input tokens
  priceOut: 0.60         // $ per 1M output tokens
};

function loadAIConfig(){
  const raw = localStorage.getItem("aiConfig");
  if (!raw) return {...aiDefaults};
  try { return {...aiDefaults, ...JSON.parse(raw)}; } catch(e){ return {...aiDefaults}; }
}
function saveAIConfig(cfg){
  localStorage.setItem("aiConfig", JSON.stringify(cfg));
}

const aiModal = document.getElementById("aiModalBackdrop");
document.getElementById("aiSettingsBtn").onclick = () => {
  const cfg = loadAIConfig();
  document.getElementById("aiProvider").value = cfg.provider;
  document.getElementById("aiBaseUrl").value = cfg.baseUrl;
  document.getElementById("aiModel").value = cfg.model;
  document.getElementById("aiKey").value = cfg.apiKey;
  document.getElementById("aiApiVersion").value = cfg.apiVersion;
  document.getElementById("aiTemp").value = cfg.temperature;

  document.getElementById("aiCap").value = cfg.monthlyCap;
  document.getElementById("aiPriceIn").value = cfg.priceIn;
  document.getElementById("aiPriceOut").value = cfg.priceOut;

  aiModal.style.display = "flex";
};
document.getElementById("aiClose").onclick = () => { aiModal.style.display = "none"; };
document.getElementById("aiSave").onclick = () => {
  const cfg = {
    provider: document.getElementById("aiProvider").value,
    baseUrl: document.getElementById("aiBaseUrl").value.trim() || aiDefaults.baseUrl,
    model: document.getElementById("aiModel").value.trim() || aiDefaults.model,
    apiKey: document.getElementById("aiKey").value.trim(),
    apiVersion: document.getElementById("aiApiVersion").value.trim() || aiDefaults.apiVersion,
    temperature: parseFloat(document.getElementById("aiTemp").value) || aiDefaults.temperature,

    monthlyCap: Math.max(0, parseFloat(document.getElementById("aiCap").value) || aiDefaults.monthlyCap),
    priceIn: Math.max(0, parseFloat(document.getElementById("aiPriceIn").value) || aiDefaults.priceIn),
    priceOut: Math.max(0, parseFloat(document.getElementById("aiPriceOut").value) || aiDefaults.priceOut)
  };
  saveAIConfig(cfg);
  aiModal.style.display = "none";
  renderCostUI(); // refresh the visible numbers
};

/* ===== test AI button (tiny probe) ===== */
document.getElementById("aiTest").onclick = async () => {
  const cfg = loadAIConfig();
  if (!cfg.apiKey){ alert("paste your api key first."); return; }
  try {
    await aiChat(cfg, [
      { role:"system", content:'reply with {"ok":true} only (json).' },
      { role:"user",   content:"ping" }
    ]);
    alert("ai test ok ‚Äî billing/key look good.");
  } catch(e){
    alert("ai test failed: " + (e?.message || e));
  }
};

/* =========================
   cost meter (estimation)
========================= */
const METER_KEY = "costMeter";
function monthKeyNow(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
}
function loadMeter(){
  const raw = localStorage.getItem(METER_KEY);
  const mk = monthKeyNow();
  let obj = { month: mk, inTok: 0, outTok: 0 };
  if (raw) { try { obj = JSON.parse(raw) || obj; } catch(e){} }
  if (obj.month !== mk) obj = { month: mk, inTok: 0, outTok: 0 };
  return obj;
}
function saveMeter(obj){
  localStorage.setItem(METER_KEY, JSON.stringify(obj));
}
function charsToTokens(s){
  if (!s) return 0;
  return Math.ceil(s.length / 4);
}
function estimateMessagesTokens(messages){
  let total = 0;
  (messages||[]).forEach(m => total += charsToTokens(m?.content || ""));
  return total;
}
function addToMeter(deltaInTok, deltaOutTok){
  const m = loadMeter();
  m.inTok += Math.max(0, Math.floor(deltaInTok||0));
  m.outTok += Math.max(0, Math.floor(deltaOutTok||0));
  saveMeter(m);
  renderCostUI();
}
function currentCost(){
  const cfg = loadAIConfig();
  const m = loadMeter();
  const dollars = (m.inTok/1e6)*cfg.priceIn + (m.outTok/1e6)*cfg.priceOut;
  return { dollars, inTok: m.inTok, outTok: m.outTok, cap: cfg.monthlyCap, priceIn: cfg.priceIn, priceOut: cfg.priceOut };
}
function renderCostUI(){
  const { dollars, inTok, outTok, cap, priceIn, priceOut } = currentCost();
  const costCard = document.getElementById("costCard");
  const capText = document.getElementById("costCapText");
  const barFill = document.getElementById("costBarFill");
  const dollarsEl = document.getElementById("costDollars");
  const inEl = document.getElementById("costTokensIn");
  const outEl = document.getElementById("costTokensOut");
  const note = document.getElementById("costNote");

  const pct = cap > 0 ? Math.min(100, Math.round((dollars / cap) * 100)) : 0;
  barFill.style.width = pct + "%";
  barFill.style.background = (pct >= 100) ? "#E35D5D" : (pct >= 80 ? "#E3B75D" : "#BADA55");
  capText.textContent = `$${dollars.toFixed(2)} / $${cap.toFixed(0)}`;
  dollarsEl.textContent = `$${dollars.toFixed(2)}`;
  inEl.textContent = `in: ${inTok.toLocaleString()} tok`;
  outEl.textContent = `out: ${outTok.toLocaleString()} tok`;

  note.textContent = `pricing used: $${priceIn}/1m input, $${priceOut}/1m output (change in ai settings).`;

  const strongWarn = (pct >= 80 && pct < 100);
  const strongDanger = (pct >= 100);
  capText.className = strongDanger ? "cost-nums cost-danger" : (strongWarn ? "cost-nums cost-warn" : "cost-nums");
}
renderCostUI();

/* =========================
   two‚Äëpass generation
========================= */
const CHUNK_CHARS = 8000;     // target size per chunk (characters)
const CHUNK_OVERLAP = 800;    // overlap to avoid boundary loss
const MAX_TRIES = 3;
const BACKOFFS = [2000, 4000, 8000]; // 429 retry delays

const tpModal = document.getElementById('tpModal');
const tpProg = document.getElementById('tpProg');
const tpStep = document.getElementById('tpStep');
const tpLog  = document.getElementById('tpLog');
document.getElementById('tpClose').onclick = ()=> tpModal.style.display = 'none';

function openProgress(msg){
  tpStep.textContent = msg || 'preparing‚Ä¶';
  tpProg.style.width = '0%';
  tpLog.textContent = '';
  tpModal.style.display = 'flex';
}
function logProgress(line){
  tpLog.textContent += (tpLog.textContent ? '\n' : '') + line;
  tpLog.scrollTop = tpLog.scrollHeight;
}
function setPct(p){ tpProg.style.width = Math.max(0, Math.min(100, p)) + '%'; }

function chunkTranscript(text){
  const chunks = [];
  let i = 0;
  while (i < text.length) {
    const end = Math.min(text.length, i + CHUNK_CHARS);
    const chunk = text.slice(i, end);
    chunks.push(chunk.trim());
    if (end >= text.length) break;
    i = end - CHUNK_OVERLAP; // overlap
    if (i < 0) i = 0;
  }
  return chunks.filter(Boolean);
}

async function aiChat(cfg, messages){
  const base = (cfg.baseUrl || "https://api.openai.com").replace(/\/+$/,"");
  let url, headers, body;

  const reqInTokens = estimateMessagesTokens(messages); // estimate prompt tokens

  if (cfg.provider === "azure") {
    url = `${base}/openai/deployments/${encodeURIComponent(cfg.model)}/chat/completions?api-version=${encodeURIComponent(cfg.apiVersion)}`;
    headers = { "Content-Type":"application/json", "api-key": cfg.apiKey };
    body = { temperature: cfg.temperature ?? 0.2, response_format: { type:"json_object" }, messages };
  } else {
    url = `${base}/v1/chat/completions`;
    headers = { "Content-Type":"application/json", "Authorization": `Bearer ${cfg.apiKey}` };
    body = { model: cfg.model || "gpt-4o-mini", temperature: cfg.temperature ?? 0.2, response_format: { type:"json_object" }, messages };
  }

  let lastText = "";
  for (let attempt=1; attempt<=MAX_TRIES; attempt++){
    const resp = await fetch(url, { method:"POST", headers, body: JSON.stringify(body) });
    if (resp.ok){
      const data = await resp.json();
      const content = data?.choices?.[0]?.message?.content || data?.choices?.[0]?.text || "";
      if (!content) throw new Error("no content in response");

      const outTok = charsToTokens(content);
      addToMeter(reqInTokens, outTok); // update cost meter

      return content;
    }

    try { lastText = await resp.clone().text(); } catch { lastText = ""; }
    let ejson = null;
    try { ejson = JSON.parse(lastText); } catch {}

    if (ejson?.error?.code === "insufficient_quota") {
      throw new Error("insufficient quota: add a payment method or raise your monthly usage limit in the openai dashboard, then try again.");
    }

    if (resp.status === 429 && attempt < MAX_TRIES){
      await new Promise(r=>setTimeout(r, BACKOFFS[attempt-1]));
      continue;
    }
    if (resp.status === 401) throw new Error("unauthorized (401): check your api key.");
    if (resp.status === 400) throw new Error("bad request (400): check model name / base url.");
    if (resp.status >= 500) throw new Error("server error: try again in a moment.");
    throw new Error(`api ${resp.status}: ${lastText || "no server message"}`);
  }
  throw new Error("api 429: still rate-limited after retries; wait a minute and try again.");
}

function pass1System(){
  return [
    "you are a careful tcm-intake extractor for an acupuncture clinic.",
    "task: read ONLY the provided transcript chunk and output STRICT JSON with facts (no rewriting, no opinions).",
    "always use lowercase; laterality abbreviations r/l/b; tcm meridians abbreviated (lv, sp, gb, bl, st, lu, li, si, ht, pc, kd, cv, gv).",
    "capture personal context if mentioned: job (occupation), family, upcoming travel or recent travel.",
    "json schema:",
    "{",
    '  "hpi_bits": ["short phrases"],',
    '  "subjective_sections": [ {"header":"string","bullets":["string","string"]} ],',
    '  "objective_sections":  [ {"header":"string","bullets":["string","string"]} ],',
    '  "explicit_tongue": "string or empty",',
    '  "explicit_pulse":  "string or empty",',
    '  "tcm_clues": ["lv qi stagnation","blood stasis","damp","heat","cold","deficiency","excess","wind","phlegm"],',
    '  "personal_context": ["job: ‚Ä¶","family: ‚Ä¶","travel: ‚Ä¶"],',
    '  "icd_candidates": ["m25.561 pain in r knee","m54.2 cervicalgia", "..."],',
    '  "herb_candidates": ["jia wei xiao yao wan","du huo ji sheng wan", "..."]',
    "}",
    "return only the json."
  ].join("\n");
}

function pass2System(){
  return [
    "you are a tcm-savvy clinical scribe for an acupuncture practice.",
    "use ALL extracted facts provided (array of chunk extracts) to write ONE consolidated note.",
    "rules:",
    "- ALL LOWERCASE.",
    "- use laterality abbreviations r, l, b.",
    "- use abbreviated tcm meridians: lv, sp, gb, bl, st, lu, li, si, ht, pc, kd, cv, gv.",
    "- never use the term 'dry needling'.",
    "- herb formulas must be PATENT formulas only.",
    "- if tongue/pulse not explicit in extracts, DEDUCE them and label clearly as deduced.",
    "- include personal context (job, family, travel) if present.",
    "output STRICT JSON with this schema:",
    "{",
    '  "hpi": "string (1‚Äì3 sentences strictly from extracts)",',
    '  "subjective": { "sections": [ {"header":"string","bullets":["string","string"]} ] },',
    '  "objective":  { "sections": [ {"header":"string","bullets":["string","string"]} ] },',
    '  "personal_context": ["string","string"],',
    '  "tongue": "string (explicit or deduced: ‚Ä¶)",',
    '  "pulse":  "string (explicit or deduced: ‚Ä¶)",',
    '  "assessment": { "bullets":["string","string"], "tcm_dx":["string","string"] },',
    '  "treatment_principle": ["string","string"],',
    '  "acupuncture_plan": {',
    '     "channels":"string",',
    '     "points_used":["string","string"],',
    '     "interventions":["acupuncture","motor/trigger point release"],',
    '     "adjuncts":["infrared","cupping","guasha","e-stim"]',
    "  },",
    '  "herb_formulas": ["string","string"],',
    '  "advice": ["string","string"],',
    '  "icd10": ["string","string","string","string"],',
    '  "confidence": 0.0,',
    '  "assumptions": ["string","string"]',
    "}",
    "respond with ONLY the json."
  ].join("\n");
}

function renderNoteFromJSON(j){
  function bullets(arr){ return (arr||[]).map(s=>"‚Äì "+(s||"")).join("\n"); }
  function sections(sec){
    if(!sec||!sec.sections) return "";
    return sec.sections.map(s=>{
      const hdr=s.header||"";
      const blt=bullets(s.bullets||[]);
      return hdr + (blt?("\n"+blt):"");
    }).join("\n");
  }

  const hpi = "hpi:\n‚Äì " + (j.hpi||"no chief complaint captured");
  const subj = "subjective:\n" + (sections(j.subjective)||"general\n‚Äì no specific subjective items captured");
  const obj  = "objective:\n" + (sections(j.objective)||"");

  const pc   = j.personal_context && j.personal_context.length
    ? "personal context:\n" + bullets(j.personal_context)
    : "";

  const tongue = "tongue:\n" + (j.tongue || "deduced: not specified");
  const pulse  = "pulse:\n"  + (j.pulse  || "deduced: not specified");

  const assess =
    "assessment (including tcm diagnosis):\n" +
    bullets(j.assessment?.bullets||[]) + "\n" +
    "tcm diagnosis:\n" + bullets(j.assessment?.tcm_dx||[]);

  const principle = "treatment principle:\n" + bullets(j.treatment_principle||[]);

  const plan = (()=>{
    const ch = j.acupuncture_plan?.channels || "lv, sp, gb, bl, st as indicated; local ashi points";
    const pts = (j.acupuncture_plan?.points_used||[]).join(", ");
    const ints = bullets(j.acupuncture_plan?.interventions||[]);
    const adj  = bullets(j.acupuncture_plan?.adjuncts||[]);
    return [
      "acupuncture plan:",
      "acupuncture",
      "‚Äì channels: " + ch,
      "‚Äì points used: " + (pts||"as clinically indicated"),
      ints?ints:"",
      "adjunct therapies",
      adj?adj:""
    ].filter(Boolean).join("\n");
  })();

  const herbs  = "herbal recommendations (patent formulas):\n" + (bullets(j.herb_formulas||[]) || "‚Äì none today");
  const advice = "advice:\n" + bullets(j.advice||[]);
  const icd    = "icd-10 codes:\n" + bullets(j.icd10||[]);

  const confVal = (typeof j.confidence === "number" && isFinite(j.confidence)) ? j.confidence : null;
  const confidenceLine = confVal!==null ? ("confidence & assumptions:\n‚Äì confidence: " + confVal.toFixed(2)) : "confidence & assumptions:";
  const assumptions = bullets(j.assumptions||[]);
  const confBlock = assumptions ? (confidenceLine + "\n" + assumptions) : confidenceLine;

  return [
    hpi, "", subj, "", obj, "",
    pc ? pc + "\n" : "",
    tongue, "", pulse, "",
    assess, "", principle, "", plan, "", herbs, "", advice, "",
    confBlock, "", icd
  ].join("\n");
}

/* ===== two‚Äëpass driver ===== */
document.getElementById("aiGenerate").onclick = async () => {
  const raw = (document.getElementById("inputText").value || "").trim();
  if (!raw){ alert("paste or dictate a transcript first."); return; }

  const cfg = loadAIConfig();
  if (!cfg.apiKey){ alert("open ai settings ‚Üí paste your api key."); return; }

  const { dollars, cap } = currentCost();
  if (cap > 0 && dollars >= cap * 0.8 && dollars < cap) {
    const ok = confirm(`heads up: you're at ~$${dollars.toFixed(2)} of your $${cap.toFixed(0)} in‚Äëapp cap. continue?`);
    if (!ok) return;
  }
  if (cap > 0 && dollars >= cap) {
    const ok = confirm(`you've reached your in‚Äëapp cap ($${cap.toFixed(0)}). continue anyway?`);
    if (!ok) return;
  }

  try {
    tpModal.style.display = 'flex';
    tpStep.textContent = "pass 1 of 2 ‚Äî extracting facts‚Ä¶";
    tpProg.style.width = '0%';
    tpLog.textContent = "splitting transcript into overlapping chunks‚Ä¶";

    const chunks = chunkTranscript(raw);
    if (!chunks.length){ throw new Error("no content after chunking."); }

    const extList = [];
    for (let i=0; i<chunks.length; i++){
      const pct = Math.round(((i)/Math.max(1,(chunks.length+1))) * 100);
      tpProg.style.width = pct + "%";
      tpStep.textContent = `pass 1 ‚Äî chunk ${i+1} of ${chunks.length}`;
      tpLog.textContent += `\nprocessing chunk ${i+1}/${chunks.length}‚Ä¶`;

      const sys = pass1System();
      const user = chunks[i];

      const content = await aiChat(cfg, [
        { role: "system", content: sys },
        { role: "user",   content: user }
      ]);

      let json;
      try { json = JSON.parse(content); }
      catch(e){
        const m = content.match(/\{[\s\S]*\}$/);
        if (m) json = JSON.parse(m[0]); else throw new Error("could not parse pass‚Äë1 json");
      }
      extList.push(json);
    }

    const preview = document.getElementById("pass1Preview");
    const previewBox = document.getElementById("pass1Text");
    const outline = [];
    const addLines = (hdr, arr)=>{
      if (arr && arr.length){
        outline.push(hdr + ":");
        Array.from(new Set(arr)).forEach(s => outline.push("‚Äì " + s));
        outline.push("");
      }
    };

    const pcAll = [], hpiBitsAll = [], tcmAll = [], icdAll = [], herbsAll = [];
    extList.forEach(e=>{
      (e.personal_context||[]).forEach(s=> pcAll.push(s));
      (e.hpi_bits||[]).forEach(s=> hpiBitsAll.push(s));
      (e.tcm_clues||[]).forEach(s=> tcmAll.push(s));
      (e.icd_candidates||[]).forEach(s=> icdAll.push(s));
      (e.herb_candidates||[]).forEach(s=> herbsAll.push(s));
    });

    addLines("hpi highlights", hpiBitsAll);
    addLines("personal context", pcAll);
    addLines("tcm clues", tcmAll);
    addLines("icd candidates", icdAll);
    addLines("herb candidates", herbsAll);

    previewBox.value = outline.join("\n").trim() || "(no preview items extracted)";
    preview.style.display = "block";

    tpStep.textContent = "pass 2 of 2 ‚Äî drafting final note‚Ä¶";
    tpProg.style.width = "90%";
    tpLog.textContent += "\nconsolidating all extracts into a single structured note‚Ä¶";

    const sys2 = pass2System();
    const user2 = JSON.stringify({ extracts: extList });

    const content2 = await aiChat(cfg, [
      { role: "system", content: sys2 },
      { role: "user",   content: user2 }
    ]);

    let finalJson;
    try { finalJson = JSON.parse(content2); }
    catch(e){
      const m2 = content2.match(/\{[\s\S]*\}$/);
      if (m2) finalJson = JSON.parse(m2[0]); else throw new Error("could not parse pass‚Äë2 json");
    }

    const note = renderNoteFromJSON(finalJson);
    document.getElementById("outputText").value = note;
    localStorage.setItem("lastNote", note);

    tpProg.style.width = "100%";
    tpStep.textContent = "done";
    tpLog.textContent += "\ncompleted ‚úî";
  } catch (e){
    tpStep.textContent = "error";
    tpLog.textContent += "\nerror: " + (e?.message || e);
  }
};

/* duplicate last */
document.getElementById("duplicateLast").onclick = () => {
  const last = localStorage.getItem("lastNote");
  if (last) document.getElementById("outputText").value = last;
};
</script>

</body>
</html>
